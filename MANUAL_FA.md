# مستندات فنی و راهنمای جامع استقرار HoseinProxy (نسخه ۲.۰.۰)

## ۱. مقدمه و دامنه کاربرد (Executive Summary & Scope)
این سند به عنوان مرجع اصلی فنی برای استقرار، نگهداری و مدیریت سامانه **HoseinProxy** تدوین شده است. این سامانه یک پلتفرم مدیریت متمرکز برای پراکسی‌های مبتنی بر پروتکل MTProto است که با هدف تسهیل دور زدن محدودیت‌های اینترنتی و ارائه ارتباطات امن طراحی شده است. دامنه کاربرد این سند شامل تیم‌های فنی، مدیران سیستم (SysAdmins) و توسعه‌دهندگان (DevOps) می‌باشد.

## ۲. معماری فنی و پیش‌نیازها (Technical Architecture & Prerequisites)
### ۲.۱. معماری سیستم
این سامانه بر اساس معماری میکروسرویس (Microservices) و کانتینریزاسیون (Containerization) بنا شده است:
- **هسته مرکزی (Core):** زبان برنامه نویسی Python با فریم‌ورک Flask.
- **لایه مدیریت پراکسی:** استفاده از Docker Engine برای ایزولاسیون و مدیریت منابع هر پراکسی.
- **پایگاه داده:** استفاده از SQLite (قابل ارتقا به PostgreSQL) برای ذخیره متادیتای کاربران و تنظیمات.
- **رابط کاربری:** طراحی شده با Bootstrap 5 و Jinja2 Template Engine.
- **لایه امنیتی:** پیاده‌سازی Rate Limiting و مکانیزم‌های Hashing برای امنیت احراز هویت.

### ۲.۲. پیش‌نیازهای سخت‌افزاری و نرم‌افزاری
برای تضمین عملکرد بهینه (SLA 99.9%)، منابع زیر مورد نیاز است:
- **سیستم عامل:** Ubuntu LTS 20.04 یا 22.04 (Kernel 5.4+).
- **پردازنده (CPU):** حداقل ۲ هسته (توصیه شده: ۴ هسته برای بار ترافیکی بالا).
- **حافظه (RAM):** حداقل ۲ گیگابایت (توصیه شده: ۴ گیگابایت).
- **فضای دیسک:** ۲۰ گیگابایت SSD (با سرعت I/O بالا).
- **شبکه:** پورت‌های ۸۰ (HTTP) و ۴۴۳ (HTTPS) و پورت‌های داینامیک برای پراکسی‌ها.
- **پیش‌نیازهای نرم‌افزاری:**
    - `Docker Engine` (نسخه ۲۰.۱۰+)
    - `Python` (نسخه ۳.۸+)
    - `Git`
    - `Curl`

## ۳. استانداردهای کیفی و امنیتی (Quality & Security Standards)
این پروژه ملزم به رعایت استانداردهای زیر است:
- **امنیت اطلاعات:**
    - تمامی رمزهای عبور باید با الگوریتم‌های استاندارد (مانند PBKDF2 یا Argon2) هش شوند.
    - استفاده از مکانیزم‌های `CSRF Protection` در تمامی فرم‌های وب الزامی است.
    - محدودسازی نرخ درخواست‌ها (Rate Limiting) برای جلوگیری از حملات Brute-force روی پنل مدیریت (حداکثر ۱۰ تلاش ناموفق در دقیقه).
- **کیفیت کد:**
    - رعایت اصول PEP8 برای کدهای پایتون.
    - جداسازی محیط‌های توسعه (Development) و عملیات (Production).
- **مدیریت سکرت‌ها:** تولید سکرت‌های پراکسی با استفاده از کتابخانه `secrets` پایتون (تولید توکن‌های رمزنگاری شده امن).

## ۴. مراحل اجرا و پیاده‌سازی (Implementation Steps)
فرایند استقرار باید طبق "چرخه حیات استقرار نرم‌افزار" (SDLC) زیر انجام شود:

### ۴.۱. فاز آماده‌سازی (Preparation)
اطمینان از به‌روز بودن مخازن سیستم عامل و نصب ابزارهای پایه:
```bash
sudo apt update && sudo apt upgrade -y
sudo apt install -y git curl
```

### ۴.۲. فاز استقرار (Deployment)
استفاده از اسکریپت خودکار `manage.sh` برای جلوگیری از خطای انسانی:
```bash
git clone https://github.com/KillHosein/HoseinProxy.git /opt/HoseinProxy
cd /opt/HoseinProxy
chmod +x manage.sh
./manage.sh
```
*در منوی ظاهر شده، گزینه ۱ (Install Panel) را انتخاب کنید.*

### ۴.۳. فاز پیکربندی (Configuration)
پس از نصب، پیکربندی اولیه از طریق پنل وب انجام می‌شود:
1. ورود به پنل از طریق `http://<SERVER_IP>`.
2. مراجعه به بخش `Settings` و تنظیم دامنه یا IP اختصاصی.
3. ایجاد اولین پراکسی از بخش `Dashboard`.

## ۵. معیارهای ارزیابی موفقیت (Success Metrics / KPIs)
موفقیت استقرار بر اساس شاخص‌های زیر سنجیده می‌شود:
1. **دسترس‌پذیری (Uptime):** پایداری سرویس بالای ۹۹.۵٪ در ماه اول.
2. **زمان پاسخگویی (Latency):** میانگین تاخیر اتصال به پراکسی کمتر از ۲۰۰ میلی‌ثانیه.
3. **مصرف منابع (Resource Usage):** مصرف CPU زیر ۷۰٪ و RAM زیر ۸۰٪ در پیک ترافیک.
4. **نرخ خطا (Error Rate):** کمتر از ۱٪ خطای اتصال در سمت کلاینت.

## ۶. مدیریت ریسک و پیچیدگی‌ها (Risk Management)
- **ریسک فیلترینگ IP:** استفاده از چندین IP یا دامنه‌های CDN برای کاهش ریسک مسدود شدن.
- **ریسک از دست رفتن داده:**
    - **راهکار:** فعال‌سازی پشتیبان‌گیری خودکار (Scheduled Backup) از طریق `manage.sh` (گزینه ۶).
    - **استراتژی بازگردانی:** استفاده از قابلیت Rollback (گزینه ۸ در `manage.sh`) در صورت خرابی پس از آپدیت.
- **ریسک امنیتی:** تغییر پورت پیش‌فرض SSH و فعال‌سازی Firewall (UFW) و تنها باز گذاشتن پورت‌های ضروری.

## ۷. مستندسازی و گزارش‌دهی (Documentation & Reporting)
- **لاگ‌های سیستم:** تمامی رخدادهای سیستمی در مسیر `/var/log/hoseinproxy/` یا از طریق دستور `journalctl -u hoseinproxy` قابل دسترسی هستند.
- **گزارش‌های پنل:** پنل مدیریت قابلیت تولید گزارش‌های گرافیکی مصرف ترافیک (دانلود/آپلود) در بازه‌های ۷ روزه را دارا می‌باشد.
- **مستندات تغییرات:** هرگونه تغییر در معماری یا تنظیمات باید در فایل `CHANGELOG.md` ثبت شود.

## ۸. محدودیت‌ها و چارچوب‌های کاری (Constraints)
- **محدودیت مقیاس‌پذیری:** نسخه فعلی برای مدیریت تک‌سرور (Single Node) بهینه شده است. برای مقیاس‌های بسیار بزرگ (Clustering) نیاز به بازطراحی معماری دیتابیس است.
- **پروتکل:** در حال حاضر تنها پروتکل MTProto پشتیبانی می‌شود.

## ۹. نکات کنترل کیفیت و تست (QA & Testing)
قبل از تحویل نهایی به کاربر، تست‌های زیر باید پاس شوند:
1. **تست عملکردی (Functional Test):** ایجاد، اتصال و حذف یک پراکسی تست.
2. **تست بار (Load Test):** شبیه‌سازی اتصال همزمان ۱۰۰ کاربر (در محیط Staging).
3. **تست بازیابی (Recovery Test):** شبیه‌سازی قطع برق یا ریستارت سرور و اطمینان از بالا آمدن خودکار سرویس‌ها (Systemd Enabled).
4. **بررسی صحت نصب:** اجرای دستور `docker ps` و اطمینان از وضعیت `Up` برای کانتینرها.

## ۱۰. اصطلاحات و مفاهیم (Glossary)
- **MTProto:** پروتکل اختصاصی تلگرام برای انتقال داده‌ها.
- **Container:** واحد نرم‌افزاری استاندارد برای بسته‌بندی کد و وابستگی‌ها (در اینجا Docker).
- **Rollback:** بازگردانی سیستم به وضعیت پایدار قبلی.
- **Cron Job:** وظایف زمان‌بندی شده در سیستم عامل لینوکس (برای آپدیت و بکاپ).
