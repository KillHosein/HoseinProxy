{% extends "layouts/base.html" %}

{% block title %}داشبورد مدیریت | HoseinProxy{% endblock %}

{% block content %}
<!-- فونت وزیرمتن با اعداد فارسی/انگلیسی استاندارد -->
<link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    :root {
        --bg-core: #020617; /* Slate 950 */
        --bg-secondary: #0f172a; /* Slate 900 */
        --glass-bg: rgba(30, 41, 59, 0.4); /* Slate 800 with opacity */
        --glass-border: rgba(255, 255, 255, 0.08);
        --glass-highlight: rgba(255, 255, 255, 0.15);
        --text-main: #f8fafc;
        --text-muted: #94a3b8;
        
        /* Brand Colors */
        --primary: #6366f1; /* Indigo 500 */
        --primary-glow: rgba(99, 102, 241, 0.4);
        --success: #10b981; /* Emerald 500 */
        --warning: #f59e0b; /* Amber 500 */
        --danger: #ef4444; /* Red 500 */
        --info: #06b6d4; /* Cyan 500 */
        
        --radius-lg: 24px;
        --radius-md: 16px;
        --radius-sm: 12px;
        
        --shadow-glass: 0 4px 30px rgba(0, 0, 0, 0.3);
    }

    body {
        font-family: 'Vazirmatn', sans-serif !important;
        background-color: var(--bg-core) !important;
        color: var(--text-main) !important;
        overflow-x: hidden;
        min-height: 100vh;
        background-image: 
            radial-gradient(circle at 15% 50%, rgba(99, 102, 241, 0.08), transparent 25%), 
            radial-gradient(circle at 85% 30%, rgba(16, 185, 129, 0.05), transparent 25%);
    }

    /* --- Animations --- */
    @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-5px); } 100% { transform: translateY(0px); } }
    @keyframes pulse-glow { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    .fade-in { animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; }
    .delay-1 { animation-delay: 0.1s; }
    .delay-2 { animation-delay: 0.2s; }
    .delay-3 { animation-delay: 0.3s; }

    /* --- Components --- */
    
    /* Modern Glass Card */
    .glass-panel {
        background: var(--glass-bg);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-glass);
        transition: transform 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .glass-panel::after {
        content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    }

    .glass-panel:hover {
        border-color: var(--glass-highlight);
        box-shadow: 0 10px 40px rgba(0,0,0,0.4);
        transform: translateY(-2px);
    }

    .panel-header {
        padding: 1.5rem;
        border-bottom: 1px solid rgba(255,255,255,0.03);
        display: flex; align-items: center; justify-content: space-between;
    }
    .panel-body { padding: 1.5rem; }

    /* Metric Cards (Top Row) */
    .metric-card {
        padding: 1.5rem;
        height: 100%;
        display: flex; flex-direction: column; justify-content: space-between;
    }
    
    .metric-icon {
        width: 48px; height: 48px;
        border-radius: var(--radius-md);
        display: flex; align-items: center; justify-content: center;
        font-size: 1.25rem;
        margin-bottom: 1rem;
        background: rgba(255,255,255,0.03);
        border: 1px solid rgba(255,255,255,0.05);
    }
    
    .metric-value {
        font-size: 2rem;
        font-weight: 700;
        letter-spacing: -0.02em;
        line-height: 1.1;
        background: linear-gradient(180deg, #fff, #cbd5e1);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-family: 'Segoe UI', 'Roboto', 'Vazirmatn', sans-serif; /* Prefer system fonts for numbers */
    }

    .metric-label {
        font-size: 0.85rem;
        color: var(--text-muted);
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    /* Buttons */
    .btn-neon {
        background: var(--primary);
        color: white;
        border: none;
        border-radius: var(--radius-sm);
        padding: 0.6rem 1.2rem;
        font-weight: 600;
        box-shadow: 0 0 15px var(--primary-glow);
        transition: all 0.3s ease;
        display: inline-flex; align-items: center; gap: 0.5rem;
    }
    .btn-neon:hover {
        transform: translateY(-2px);
        box-shadow: 0 0 25px var(--primary-glow);
        color: white;
    }

    .btn-icon-glass {
        width: 36px; height: 36px;
        display: inline-flex; align-items: center; justify-content: center;
        border-radius: 10px;
        background: rgba(255,255,255,0.03);
        border: 1px solid rgba(255,255,255,0.05);
        color: var(--text-muted);
        transition: all 0.2s;
    }
    .btn-icon-glass:hover {
        background: rgba(255,255,255,0.1);
        color: white;
        transform: scale(1.05);
    }

    /* Data Table */
    .table-container {
        overflow-x: auto;
    }
    .modern-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 8px; /* Spacing between rows */
    }
    
    .modern-table thead th {
        color: var(--text-muted);
        font-weight: 600;
        font-size: 0.8rem;
        text-transform: uppercase;
        padding: 0 1.5rem 0.75rem 1.5rem;
        border: none;
        text-align: right;
    }
    
    .modern-table tbody tr {
        background: rgba(255, 255, 255, 0.02);
        transition: all 0.2s ease;
    }
    
    .modern-table tbody tr:hover {
        background: rgba(255, 255, 255, 0.05);
        transform: scale(1.005); /* Subtle zoom */
    }
    
    .modern-table td {
        padding: 1rem 1.5rem;
        vertical-align: middle;
        border-top: 1px solid rgba(255,255,255,0.02);
        border-bottom: 1px solid rgba(255,255,255,0.02);
    }
    
    .modern-table td:first-child { border-top-right-radius: var(--radius-sm); border-bottom-right-radius: var(--radius-sm); border-right: 1px solid rgba(255,255,255,0.05); }
    .modern-table td:last-child { border-top-left-radius: var(--radius-sm); border-bottom-left-radius: var(--radius-sm); border-left: 1px solid rgba(255,255,255,0.05); }

    /* Inputs */
    .form-glass {
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid rgba(255,255,255,0.1);
        color: white;
        border-radius: var(--radius-sm);
        padding: 0.6rem 1rem;
    }
    .form-glass:focus {
        background: rgba(15, 23, 42, 0.8);
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        color: white;
    }
    .form-glass::placeholder { color: rgba(255,255,255,0.3); }

    /* Status Indicators */
    .status-dot {
        width: 8px; height: 8px; border-radius: 50%; display: inline-block;
        margin-left: 6px;
    }
    .status-dot.active { background: var(--success); box-shadow: 0 0 8px var(--success); animation: pulse-glow 2s infinite; }
    .status-dot.inactive { background: var(--danger); box-shadow: 0 0 5px var(--danger); }

    /* Progress Bars */
    .progress-slim {
        height: 6px;
        background: rgba(255,255,255,0.05);
        border-radius: 10px;
        overflow: hidden;
    }
    .progress-bar-glow {
        box-shadow: 0 0 10px currentColor;
    }

    /* Tabs */
    .nav-pills-glass .nav-link {
        color: var(--text-muted);
        background: transparent;
        border-radius: var(--radius-sm);
        padding: 0.5rem 1.25rem;
        transition: all 0.3s;
    }
    .nav-pills-glass .nav-link.active {
        background: rgba(255,255,255,0.1);
        color: white;
        font-weight: 600;
    }

    /* Modal Override */
    .modal-content.glass-panel {
        background: #0f172a; /* Solid but dark for readability */
        border: 1px solid rgba(255,255,255,0.1);
    }
    .modal-backdrop.show { opacity: 0.8; backdrop-filter: blur(5px); }

    /* Utilities */
    .font-mono { font-family: 'Roboto Mono', 'Consolas', monospace; }
    .text-gradient-primary {
        background: linear-gradient(135deg, #818cf8, #c084fc);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    @media (max-width: 768px) {
        .metric-value { font-size: 1.5rem; }
        .modern-table thead { display: none; }
        .modern-table tbody tr { display: flex; flex-direction: column; padding: 1rem; height: auto; margin-bottom: 1rem; }
        .modern-table td { border: none; padding: 0.5rem 0; display: flex; justify-content: space-between; width: 100%; }
        .modern-table td::before { content: attr(data-label); color: var(--text-muted); font-size: 0.85rem; }
        .modern-table td:first-child, .modern-table td:last-child { border-radius: 0; border: none; }
    }
</style>

<!-- Canvas for Stars -->
<canvas id="starfield" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; opacity: 0.6; pointer-events: none;"></canvas>

<div class="container-fluid py-5 px-lg-5">
    
    <!-- Header Section -->
    <div class="d-flex flex-wrap justify-content-between align-items-end mb-5 fade-in">
        <div>
            <h1 class="fw-bold mb-1 text-white tracking-tight">داشبورد <span class="text-gradient-primary">مدیریت</span></h1>
            <p class="text-muted mb-0">HoseinProxy Admin Panel • v2.0</p>
        </div>
        
        <!-- System Health Pill -->
        <div class="glass-panel px-4 py-2 mt-3 mt-md-0 d-flex align-items-center gap-4 rounded-pill">
            <div class="d-flex flex-column align-items-center">
                <span class="text-muted" style="font-size: 0.65rem; letter-spacing: 1px;">UPTIME</span>
                <span id="uptime-display" class="fw-bold text-white small font-mono">...</span>
            </div>
            <div class="vr bg-white opacity-10"></div>
            <div class="d-flex flex-column align-items-center">
                <span class="text-muted" style="font-size: 0.65rem; letter-spacing: 1px;">PING</span>
                <span id="latency-display" class="fw-bold text-success small font-mono">--</span>
            </div>
            <div class="vr bg-white opacity-10"></div>
            <div class="d-flex align-items-center gap-2">
                <span class="status-dot active"></span>
                <span class="small text-white fw-bold">Online</span>
            </div>
        </div>
    </div>

    <!-- Top Metrics Row -->
    <div class="row g-4 mb-5">
        <!-- CPU -->
        <div class="col-xl-3 col-md-6 fade-in delay-1">
            <div class="glass-panel metric-card">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="metric-icon text-primary"><i class="fas fa-microchip"></i></div>
                    <div class="text-end">
                        <div class="metric-label">پردازنده</div>
                        <div class="metric-value font-mono"><span id="cpu-usage">--</span><small class="fs-6 opacity-50">%</small></div>
                    </div>
                </div>
                <div>
                    <div class="progress-slim mb-2 bg-dark">
                        <div id="cpu-bar" class="progress-bar bg-primary progress-bar-glow" style="width: 0%"></div>
                    </div>
                    <div class="d-flex justify-content-between small text-muted">
                        <span>Load Avg</span>
                        <span id="load-avg-display" class="font-mono text-white">--</span>
                    </div>
                </div>
                <!-- Sparkline Overlay -->
                <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 40px; opacity: 0.3; mask-image: linear-gradient(to top, black, transparent);">
                    <canvas id="sparkCpu"></canvas>
                </div>
            </div>
        </div>

        <!-- RAM -->
        <div class="col-xl-3 col-md-6 fade-in delay-1">
            <div class="glass-panel metric-card">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="metric-icon text-success"><i class="fas fa-memory"></i></div>
                    <div class="text-end">
                        <div class="metric-label">حافظه رم</div>
                        <div class="metric-value font-mono"><span id="ram-usage">--</span><small class="fs-6 opacity-50">%</small></div>
                    </div>
                </div>
                <div>
                    <div class="progress-slim mb-2 bg-dark">
                        <div id="ram-bar" class="progress-bar bg-success progress-bar-glow" style="width: 0%"></div>
                    </div>
                    <div class="d-flex justify-content-between small text-muted">
                        <span>Used: <span id="ram-used" class="text-white">--</span> GB</span>
                        <span>Total: <span id="ram-total">--</span></span>
                    </div>
                </div>
                 <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 40px; opacity: 0.3; mask-image: linear-gradient(to top, black, transparent);">
                    <canvas id="sparkRam"></canvas>
                </div>
            </div>
        </div>

        <!-- Network -->
        <div class="col-xl-3 col-md-6 fade-in delay-2">
            <div class="glass-panel metric-card">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="metric-icon text-info"><i class="fas fa-network-wired"></i></div>
                    <div class="text-end">
                        <div class="metric-label">سرعت دانلود</div>
                        <div class="metric-value font-mono" style="font-size: 1.8rem;"><span id="net-down-speed">0</span> <small class="fs-6 opacity-50">MB/s</small></div>
                    </div>
                </div>
                 <div class="mt-auto">
                    <div class="d-flex align-items-center gap-2 small text-muted mb-2">
                        <i class="fas fa-arrow-down text-info"></i>
                        <span>Total DL:</span>
                        <span id="net-total-down" class="text-white font-mono ms-auto">--</span>
                    </div>
                 </div>
                 <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 40px; opacity: 0.3; mask-image: linear-gradient(to top, black, transparent);">
                    <canvas id="sparkNet"></canvas>
                </div>
            </div>
        </div>

        <!-- Active Users/Proxies -->
        <div class="col-xl-3 col-md-6 fade-in delay-2">
            <div class="glass-panel metric-card">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="metric-icon text-warning"><i class="fas fa-users"></i></div>
                    <div class="text-end">
                        <div class="metric-label">پروکسی‌های فعال</div>
                        <div class="metric-value font-mono text-warning">{{ proxies|selectattr('status', 'equalto', 'running')|list|length }}</div>
                    </div>
                </div>
                <div class="mt-auto">
                     <div class="d-flex align-items-center justify-content-between small text-muted mb-1">
                        <span>Total Created</span>
                        <span class="text-white font-mono">{{ proxies|length }}</span>
                    </div>
                    <div class="progress-slim bg-dark">
                        {% set running = proxies|selectattr('status', 'equalto', 'running')|list|length %}
                        {% set total = proxies|length %}
                        {% set pct = (running / total * 100) if total > 0 else 0 %}
                        <div class="progress-bar bg-warning progress-bar-glow" style="width: {{ pct }}%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Area -->
    <div class="row g-4 mb-5 fade-in delay-3">
        <div class="col-lg-8">
            <div class="glass-panel h-100">
                <div class="panel-header">
                    <div>
                        <h5 class="mb-0 fw-bold text-white">مانیتورینگ منابع</h5>
                        <small class="text-muted">وضعیت لحظه‌ای سرور</small>
                    </div>
                    <div class="d-flex gap-2">
                        <span class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25 px-3 py-2 rounded-pill fw-normal">CPU</span>
                        <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 px-3 py-2 rounded-pill fw-normal">RAM</span>
                    </div>
                </div>
                <div class="panel-body">
                    <div style="height: 320px; width: 100%;"><canvas id="systemChart"></canvas></div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="glass-panel h-100">
                <div class="panel-header">
                    <h5 class="mb-0 fw-bold text-white">آمار مصرف</h5>
                    <ul class="nav nav-pills-glass" role="tablist">
                        <li class="nav-item"><button class="nav-link active small py-1 px-3" data-bs-toggle="tab" data-bs-target="#tab-traffic">ترافیک</button></li>
                        <li class="nav-item"><button class="nav-link small py-1 px-3" data-bs-toggle="tab" data-bs-target="#tab-countries" onclick="updateCountryChart()">کشورها</button></li>
                    </ul>
                </div>
                <div class="panel-body tab-content h-100 d-flex flex-column justify-content-center">
                    <div class="tab-pane fade show active w-100" id="tab-traffic">
                        <div style="height: 280px;"><canvas id="trafficChart"></canvas></div>
                    </div>
                    <div class="tab-pane fade w-100 position-relative" id="tab-countries">
                        <div style="height: 280px;"><canvas id="countryChart"></canvas></div>
                        <div id="countryChartLoading" class="position-absolute top-50 start-50 translate-middle text-muted small">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Proxy Table -->
    <div class="glass-panel fade-in delay-3 mb-5">
        <div class="panel-header flex-wrap gap-3">
            <div class="d-flex align-items-center gap-3">
                <div class="bg-primary bg-opacity-10 text-primary p-2 rounded-3">
                    <i class="fas fa-list-ul"></i>
                </div>
                <div>
                    <h5 class="mb-0 fw-bold text-white">لیست پروکسی‌ها</h5>
                    <small class="text-muted">{{ proxies|length }} کانفیگ موجود</small>
                </div>
            </div>
            
            <div class="d-flex gap-2 ms-auto flex-wrap">
                <div class="input-group" style="width: 250px;">
                    <span class="input-group-text bg-dark border-secondary border-opacity-25 text-secondary"><i class="fas fa-search"></i></span>
                    <input id="proxySearch" type="text" class="form-control form-glass border-start-0 ps-0" placeholder="جستجو (پورت، نام، تگ)...">
                </div>
                
                <select id="proxyStatusFilter" class="form-select form-glass w-auto cursor-pointer">
                    <option value="">همه</option>
                    <option value="running">فعال</option>
                    <option value="stopped">متوقف</option>
                </select>
                
                <button class="btn btn-outline-secondary border-secondary border-opacity-25 text-white" data-bs-toggle="modal" data-bs-target="#bulkCreateModal">
                    <i class="fas fa-layer-group me-2"></i>گروهی
                </button>
                
                <button class="btn btn-neon" data-bs-toggle="modal" data-bs-target="#addProxyModal">
                    <i class="fas fa-plus"></i>
                    <span>پروکسی جدید</span>
                </button>
            </div>
        </div>

        <div class="panel-body p-0">
            <div class="table-container px-3 pb-3">
                <table id="proxiesTable" class="modern-table">
                    <thead>
                        <tr>
                            <th>پورت</th>
                            <th class="text-end">نام / تگ</th>
                            <th class="text-center">وضعیت</th>
                            <th class="text-center">اتصالات</th>
                            <th class="text-center">مصرف (GB)</th>
                            <th class="text-center">عملیات</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for proxy in proxies %}
                        <tr class="fade-in">
                            <!-- Port -->
                            <td data-label="پورت" data-proxy-port="{{ proxy.port }}">
                                <div class="d-flex align-items-center gap-3">
                                    <div class="bg-white bg-opacity-5 p-2 rounded-3">
                                        <i class="fas fa-ethernet text-muted"></i>
                                    </div>
                                    <div>
                                        <div class="font-mono fw-bold text-info fs-5">{{ proxy.port }}</div>
                                        <div class="small text-muted font-mono" style="font-size: 0.7rem;">MTProto</div>
                                    </div>
                                </div>
                            </td>
                            
                            <!-- Name/Tag -->
                            <td data-label="مشخصات" class="text-end">
                                <div class="d-flex flex-column align-items-end">
                                    <span class="fw-bold text-white mb-1">{{ proxy.name or 'کاربر ناشناس' }}</span>
                                    {% if proxy.tag %}
                                    <span class="badge bg-dark border border-white border-opacity-10 text-muted fw-normal" data-proxy-tag="{{ proxy.tag }}">
                                        <i class="fas fa-tag me-1 opacity-50"></i>{{ proxy.tag }}
                                    </span>
                                    {% endif %}
                                </div>
                            </td>
                            
                            <!-- Status -->
                            <td data-label="وضعیت" class="text-center">
                                {% if proxy.status == 'running' %}
                                    <div class="d-inline-flex align-items-center gap-2 px-3 py-1 rounded-pill bg-success bg-opacity-10 border border-success border-opacity-20 text-success small fw-bold" data-proxy-status="running">
                                        <span class="status-dot active ms-0"></span> فعال
                                    </div>
                                {% else %}
                                    <div class="d-inline-flex align-items-center gap-2 px-3 py-1 rounded-pill bg-danger bg-opacity-10 border border-danger border-opacity-20 text-danger small fw-bold" data-proxy-status="stopped">
                                        <span class="status-dot inactive ms-0"></span> متوقف
                                    </div>
                                {% endif %}
                            </td>
                            
                            <!-- Connections -->
                            <td data-label="اتصالات" class="text-center">
                                <button class="btn btn-sm btn-link text-decoration-none text-white d-inline-flex align-items-center gap-2 opacity-75 hover-opacity-100" onclick="openProxyDetails(this.dataset.id, this.dataset.port)" data-id="{{ proxy.id }}" data-port="{{ proxy.port }}">
                                    <i class="fas fa-users text-primary"></i>
                                    <span class="font-mono fw-bold" id="proxy-users-{{ proxy.id }}">{{ proxy.active_connections }}</span>
                                </button>
                                <div class="small text-warning font-mono mt-1" id="proxy-download-rate-{{ proxy.id }}" style="font-size: 0.7rem;">0 KB/s</div>
                            </td>
                            
                            <!-- Quota -->
                            <td data-label="حجم مصرفی" style="min-width: 160px;">
                                <div class="d-flex justify-content-between small mb-1 px-1">
                                    <span class="text-white font-mono" id="proxy-quota-used-{{ proxy.id }}">-</span>
                                    <span class="text-muted font-mono" id="proxy-quota-total-{{ proxy.id }}">-</span>
                                </div>
                                <div class="progress-slim bg-dark">
                                    <div id="proxy-quota-bar-{{ proxy.id }}" class="progress-bar bg-gradient-to-r from-blue-400 to-indigo-500" style="width: 0%"></div>
                                </div>
                                {% if proxy.expiry_date %}
                                <div class="mt-1 text-center text-muted" style="font-size: 0.7rem;">
                                    <i class="far fa-clock me-1"></i>
                                    <span class="{{ 'text-danger' if proxy.expiry_date < now else '' }}">{{ proxy.expiry_date.strftime('%Y-%m-%d') }}</span>
                                </div>
                                {% endif %}
                            </td>
                            
                            <!-- Actions -->
                            <td data-label="مدیریت" class="text-center">
                                <div class="d-flex gap-2 justify-content-center">
                                    <button class="btn-icon-glass text-info" onclick="copyProxyLink(this.dataset.port, this.dataset.secret, this.dataset.ip)" data-port="{{ proxy.port }}" data-secret="{{ proxy.display_secret }}" data-ip="{{ proxy.proxy_ip or '' }}" title="کپی لینک">
                                        <i class="far fa-copy"></i>
                                    </button>
                                    
                                    <div class="vr bg-white opacity-10 mx-1"></div>

                                    {% if proxy.status == 'running' %}
                                    <a href="{{ url_for('proxy.stop', id=proxy.id) }}" class="btn-icon-glass text-danger" title="توقف">
                                        <i class="fas fa-power-off"></i>
                                    </a>
                                    {% else %}
                                    <a href="{{ url_for('proxy.start', id=proxy.id) }}" class="btn-icon-glass text-success" title="شروع">
                                        <i class="fas fa-play"></i>
                                    </a>
                                    {% endif %}
                                    
                                    <button class="btn-icon-glass text-primary" onclick="handleProxyEdit(this)" data-id="{{ proxy.id }}" data-port="{{ proxy.port }}" data-tag="{{ proxy.tag or '' }}" data-quota="{{ ((proxy.quota_bytes / (1024*1024*1024))|round(2) if proxy.quota_bytes else 0) }}" data-secret="{{ proxy.display_secret }}" data-status="{{ proxy.status }}" data-username="{{ proxy.username or '' }}" data-password="{{ proxy.password or '' }}" data-ip="{{ proxy.proxy_ip or '' }}" data-name="{{ proxy.name or '' }}" title="تنظیمات">
                                        <i class="fas fa-cog"></i>
                                    </button>

                                    <a href="{{ url_for('proxy.delete', id=proxy.id) }}" onclick="return confirm('آیا از حذف این پروکسی اطمینان دارید؟')" class="btn-icon-glass text-danger" title="حذف">
                                        <i class="fas fa-trash-alt"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="6" class="text-center py-5 text-muted">هنوز هیچ پروکسی ساخته نشده است.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Logs Section -->
    <div class="row fade-in delay-3 pb-5">
        <div class="col-lg-6 mb-4 mb-lg-0">
            <div class="glass-panel h-100">
                <div class="panel-header">
                    <h6 class="mb-0 text-white"><i class="fas fa-bell text-warning me-2"></i>هشدارها</h6>
                    <span class="badge bg-danger rounded-pill shadow-sm" id="alertsCount">0</span>
                </div>
                <div class="panel-body p-0">
                    <ul class="list-group list-group-flush bg-transparent" id="alertsList">
                        <li class="list-group-item text-muted border-0 py-4 text-center bg-transparent small">هشداری ثبت نشده است.</li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="glass-panel h-100">
                <div class="panel-header">
                    <h6 class="mb-0 text-white"><i class="fas fa-history text-info me-2"></i>لاگ فعالیت‌ها</h6>
                    <button class="btn btn-sm btn-icon-glass rounded-circle" onclick="updateActivityLogs()"><i class="fas fa-sync-alt"></i></button>
                </div>
                <div class="panel-body p-0">
                    <ul class="list-group list-group-flush bg-transparent" id="activityList">
                        <li class="list-group-item text-muted border-0 py-4 text-center bg-transparent small">در حال بارگذاری...</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals (Styling Updated) -->
<!-- Add Proxy Modal -->
<div class="modal fade" id="addProxyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content glass-panel text-start">
            <div class="modal-header border-bottom border-secondary border-opacity-10">
                <h5 class="modal-title text-white fw-bold">افزودن پروکسی</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('proxy.add') }}" method="POST">
                <div class="modal-body p-4">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="text-muted small mb-1">پورت</label>
                            <input type="number" name="port" class="form-control form-glass font-mono" required placeholder="e.g. 443">
                        </div>
                         <div class="col-md-6">
                            <label class="text-muted small mb-1">پروتکل</label>
                            <select name="proxy_type" id="proxyType" class="form-select form-glass">
                                <option value="standard">Standard</option>
                                <option value="dd">DD (Anti-Filter)</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="text-muted small mb-1">Secret Key</label>
                            <div class="input-group">
                                <input type="text" name="secret" id="newSecret" class="form-control form-glass font-mono text-warning" placeholder="تولید خودکار...">
                                <button class="btn btn-outline-secondary border-secondary border-opacity-25" type="button" onclick="generateSecret()"><i class="fas fa-dice"></i></button>
                            </div>
                        </div>
                        <div class="col-md-6">
                             <label class="text-muted small mb-1">محدودیت حجم (GB)</label>
                             <input type="number" name="quota_gb" class="form-control form-glass" placeholder="0 = نامحدود">
                         </div>
                         <div class="col-md-6">
                             <label class="text-muted small mb-1">انقضا (روز)</label>
                             <input type="number" name="expiry_days" class="form-control form-glass" placeholder="0 = نامحدود">
                         </div>
                         <div class="col-12">
                            <label class="text-muted small mb-1">توضیحات / تگ</label>
                            <input type="text" name="tag" class="form-control form-glass" placeholder="نام کاربر یا تگ...">
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 p-3 pt-0">
                    <button type="button" class="btn btn-link text-muted text-decoration-none" data-bs-dismiss="modal">لغو</button>
                    <button type="submit" class="btn btn-neon rounded-3">ایجاد</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Proxy Modal (Simplified for brevity but uses same style) -->
<div class="modal fade" id="editProxyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content glass-panel text-start">
            <div class="modal-header border-bottom border-secondary border-opacity-10">
                <h5 class="modal-title text-white">ویرایش پروکسی</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="editProxyForm" method="POST">
                <div class="modal-body p-4">
                    <div class="alert alert-warning small bg-warning bg-opacity-10 text-warning border border-warning border-opacity-25 p-3 mb-4 rounded-3 d-flex align-items-center">
                        <i class="fas fa-exclamation-triangle me-3 fs-4"></i>
                        <div>تغییر پورت یا سکرت باعث قطع موقت اتصال کاربر می‌شود.</div>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="text-muted small mb-1">پورت</label>
                            <input type="number" name="port" id="editProxyPort" class="form-control form-glass font-mono" required>
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted small mb-1">وضعیت</label>
                            <select name="status" id="editProxyStatus" class="form-select form-glass">
                                <option value="running">فعال</option>
                                <option value="stopped">متوقف</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="text-muted small mb-1">Secret</label>
                            <div class="input-group">
                                <input type="text" name="secret" id="editProxySecret" class="form-control form-glass font-mono text-warning">
                                <button class="btn btn-outline-secondary border-secondary border-opacity-25" type="button" onclick="setRandomSecretForEdit()"><i class="fas fa-sync"></i></button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted small mb-1">حجم (GB)</label>
                            <input type="number" name="quota_gb" id="editProxyQuota" class="form-control form-glass">
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted small mb-1">نام</label>
                            <input type="text" name="name" id="editProxyName" class="form-control form-glass">
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted small mb-1">تگ</label>
                            <input type="text" name="tag" id="editProxyTag" class="form-control form-glass">
                        </div>
                        <input type="hidden" name="proxy_ip" id="editProxyIP">
                        <input type="hidden" name="username" id="editProxyUser">
                        <input type="hidden" name="password" id="editProxyPass">
                        <div class="d-none" id="editTlsDomainField"><input type="hidden" name="tls_domain" id="editProxyTlsDomain"></div>
                    </div>
                </div>
                <div class="modal-footer border-0 p-3 pt-0">
                    <button type="button" class="btn btn-link text-muted text-decoration-none" data-bs-dismiss="modal">لغو</button>
                    <button type="submit" class="btn btn-neon rounded-3">ذخیره تغییرات</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bulk Create Modal -->
<div class="modal fade" id="bulkCreateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content glass-panel text-start">
            <div class="modal-header border-bottom border-secondary border-opacity-10">
                <h5 class="modal-title text-white">ساخت گروهی</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('proxy.bulk_create') }}" method="POST">
                <div class="modal-body p-4">
                    <div class="mb-3">
                        <label class="text-muted small mb-1">پورت شروع</label>
                        <input type="number" name="start_port" class="form-control form-glass font-mono" required placeholder="e.g. 20000">
                    </div>
                    <div class="mb-3">
                        <label class="text-muted small mb-1">تعداد</label>
                        <input type="number" name="count" class="form-control form-glass" value="10">
                    </div>
                    <div class="mb-3">
                        <label class="text-muted small mb-1">تگ</label>
                        <input type="text" name="tag" class="form-control form-glass" placeholder="Bulk-Tag">
                    </div>
                    <div class="mb-3">
                        <label class="text-muted small mb-1">پیشوند نام</label>
                        <input type="text" name="name_prefix" class="form-control form-glass" placeholder="User">
                    </div>
                </div>
                <div class="modal-footer border-0 p-3 pt-0">
                    <button type="submit" class="btn btn-neon w-100 rounded-3">شروع ساخت</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Details Modal -->
<div class="modal fade" id="proxyDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content glass-panel border-0">
            <div class="modal-header border-bottom border-secondary border-opacity-10">
                <h5 class="modal-title text-white">جزئیات: <span id="detailsPort" class="text-info font-mono"></span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row g-4">
                    <div class="col-lg-4">
                        <div class="glass-panel bg-transparent h-100 border border-secondary border-opacity-25">
                            <div class="panel-header py-2 border-bottom border-secondary border-opacity-25">
                                <h6 class="mb-0 text-white small fw-bold">کاربران آنلاین</h6>
                                <input id="connIpFilter" class="form-control form-control-sm form-glass w-50" placeholder="IP...">
                            </div>
                            <div class="panel-body p-0">
                                <div class="table-responsive" style="max-height: 350px;">
                                    <table class="table table-sm table-dark mb-0 bg-transparent table-hover">
                                        <thead class="text-muted small sticky-top bg-dark"><tr><th class="ps-3">IP</th><th>کشور</th><th>زمان</th></tr></thead>
                                        <tbody id="connectionsTable"><tr><td colspan="3" class="text-center text-muted small py-3">...</td></tr></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-8">
                        <div class="glass-panel bg-transparent mb-4 border border-secondary border-opacity-25 p-3">
                            <h6 class="text-white small fw-bold mb-3 border-bottom border-secondary border-opacity-10 pb-2">ترافیک لحظه‌ای</h6>
                            <div style="height: 200px;"><canvas id="connectionsChart"></canvas></div>
                        </div>
                         <div class="glass-panel bg-transparent border border-secondary border-opacity-25 p-3">
                            <div class="d-flex justify-content-between align-items-center mb-3 border-bottom border-secondary border-opacity-10 pb-2">
                                <h6 class="text-white small fw-bold mb-0">تاریخچه مصرف</h6>
                                <select id="usageGranularity" class="form-select form-select-sm form-glass w-auto py-0 h-auto">
                                    <option value="daily">روزانه</option>
                                    <option value="hourly">ساعتی</option>
                                </select>
                            </div>
                            <div style="height: 200px;"><canvas id="usageChart"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary rounded-3 px-4" data-bs-dismiss="modal">بستن</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // --- Starfield (Optimized & Subtle) ---
    const canvas = document.getElementById('starfield');
    const ctx = canvas.getContext('2d');
    let width, height, stars = [];
    const resizeCanvas = () => { width = window.innerWidth; height = window.innerHeight; canvas.width = width; canvas.height = height; };
    class Star {
        constructor() { this.reset(); }
        reset() { this.x = Math.random()*width; this.y = Math.random()*height; this.size = Math.random()*1.5; this.speed = Math.random()*0.02+0.005; this.opacity = Math.random()*0.5; }
        update() { this.y -= this.speed; if(this.y<0) this.reset(); }
        draw() { ctx.fillStyle = `rgba(255,255,255,${this.opacity})`; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fill(); }
    }
    const initStars = () => { stars = Array.from({length:50}, () => new Star()); };
    const animateStars = () => { ctx.clearRect(0,0,width,height); stars.forEach(s => { s.update(); s.draw(); }); requestAnimationFrame(animateStars); };
    window.addEventListener('resize', () => { resizeCanvas(); initStars(); });
    resizeCanvas(); initStars(); animateStars();

    // --- Helpers ---
    const formatBytes = (bytes) => { if(!+bytes) return '0 B'; const k=1024, sizes=['B','KB','MB','GB','TB'], i=Math.floor(Math.log(bytes)/Math.log(k)); return `${parseFloat((bytes/Math.pow(k,i)).toFixed(2))} ${sizes[i]}`; };
    const copyToClipboard = (text) => { navigator.clipboard.writeText(text).then(()=>Swal.fire({toast:true, position:'bottom', icon:'success', title:'کپی شد', showConfirmButton:false, timer:1500, background:'#0f172a', color:'#fff'})); };
    
    // JS Logic for Modals & Actions
    const generateSecret = () => { const t=document.getElementById('proxyType').value; let s=[...Array(32)].map(()=>Math.floor(Math.random()*16).toString(16)).join(''); document.getElementById('newSecret').value = t==='dd'?'dd'+s:s; };
    const copyProxyLink = (port, secret, ip) => { const sip = ip || '{{ server_ip }}' || window.location.hostname; copyToClipboard(`tg://proxy?server=${sip}&port=${port}&secret=${secret}`); };
    const formatUptime = (s) => { const d=Math.floor(s/86400), h=Math.floor(s%86400/3600), m=Math.floor(s%3600/60); return d>0?`${d}d ${h}h`:`${h}h ${m}m`; };

    const handleProxyEdit = (btn) => {
        const d = btn.dataset;
        const form = document.getElementById('editProxyForm'); form.action = `/proxy/update/${d.id}`;
        ['Port','Name','Secret','Quota','Status','Tag','User','Pass','IP'].forEach(k => { const el=document.getElementById(`editProxy${k}`); if(el) el.value = d[k.toLowerCase()]||''; });
        new bootstrap.Modal(document.getElementById('editProxyModal')).show();
    };

    // --- Chart Config (Gradient Look) ---
    Chart.defaults.font.family = 'Vazirmatn'; 
    Chart.defaults.color = '#64748b'; 
    Chart.defaults.borderColor = 'rgba(255,255,255,0.02)';
    
    const createGradient = (ctx, c1, c2) => { const g=ctx.createLinearGradient(0,0,0,300); g.addColorStop(0,c1); g.addColorStop(1,c2); return g; };

    const sysCtx = document.getElementById('systemChart').getContext('2d');
    const sysChart = new Chart(sysCtx, {
        type: 'line',
        data: { labels:Array(20).fill(''), datasets:[
            { label:'CPU', data:Array(20).fill(0), borderColor:'#6366f1', backgroundColor:createGradient(sysCtx,'rgba(99,102,241,0.3)','rgba(99,102,241,0)'), fill:true, tension:0.4, borderWidth:2, pointRadius:0 },
            { label:'RAM', data:Array(20).fill(0), borderColor:'#10b981', backgroundColor:'transparent', borderDash:[5,5], tension:0.4, borderWidth:2, pointRadius:0 }
        ]},
        options: { responsive:true, maintainAspectRatio:false, interaction:{mode:'index',intersect:false}, plugins:{legend:{labels:{usePointStyle:true,boxWidth:6}}}, scales:{x:{display:false}, y:{min:0, max:100, grid:{display:true, color:'rgba(255,255,255,0.03)'}}} }
    });

    const trafCtx = document.getElementById('trafficChart').getContext('2d');
    const trafChart = new Chart(trafCtx, {
        type: 'bar', 
        data: { labels:[], datasets:[{ label:'Download', data:[], backgroundColor:'#06b6d4', borderRadius:4, barThickness:12 }] },
        options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{grid:{display:false}}, y:{grid:{color:'rgba(255,255,255,0.03)'}}} }
    });

    // Sparklines
    const mkSpark = (id, color) => new Chart(document.getElementById(id), { type:'line', data:{labels:Array(10).fill(''), datasets:[{data:Array(10).fill(0), borderColor:color, borderWidth:2, tension:0.5, pointRadius:0, fill:false}]}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false},tooltip:{enabled:false}}, scales:{x:{display:false}, y:{display:false}}} });
    const sparkCpu = mkSpark('sparkCpu', '#6366f1');
    const sparkRam = mkSpark('sparkRam', '#10b981');
    const sparkNet = mkSpark('sparkNet', '#06b6d4');

    // --- Updates ---
    let lastNetRecv=null, lastTime=Date.now();
    
    const updateStats = () => fetch('/api/stats').then(r=>r.json()).then(d => {
        document.getElementById('cpu-usage').innerText = d.cpu;
        document.getElementById('ram-usage').innerText = d.mem_percent;
        document.getElementById('ram-used').innerText = d.mem_used;
        document.getElementById('ram-total').innerText = d.mem_total;
        document.getElementById('uptime-display').innerText = formatUptime(d.uptime||0);
        document.getElementById('load-avg-display').innerText = (d.load_avg||['-'])[0];
        
        // Net Speed calc
        const now=Date.now(), tDiff=(now-lastTime)/1000;
        if(lastNetRecv!==null && tDiff>0) {
            const spd = ((d.net_recv - lastNetRecv)/1024/1024)/tDiff;
            document.getElementById('net-down-speed').innerHTML = spd.toFixed(1);
            // Sparkline Net
            sparkNet.data.datasets[0].data.push(spd); sparkNet.data.datasets[0].data.shift(); sparkNet.update('none');
        }
        lastNetRecv=d.net_recv; lastTime=now;
        document.getElementById('net-total-down').innerText = formatBytes(d.net_recv);

        // Chart Updates
        document.getElementById('cpu-bar').style.width = d.cpu+'%';
        document.getElementById('ram-bar').style.width = d.mem_percent+'%';
        
        const pushData = (c, ds, v) => { c.data.datasets[ds].data.push(v); c.data.datasets[ds].data.shift(); };
        pushData(sysChart, 0, d.cpu); pushData(sysChart, 1, d.mem_percent); sysChart.update('none');
        pushData(sparkCpu, 0, d.cpu); sparkCpu.update('none');
        pushData(sparkRam, 0, d.mem_percent); sparkRam.update('none');
    });

    const updateProxies = () => fetch('/api/proxies').then(r=>r.json()).then(d => {
        d.forEach(p => {
            const u = document.getElementById(`proxy-users-${p.id}`);
            if(u) u.innerText = p.active_connections;
            const qU = document.getElementById(`proxy-quota-used-${p.id}`);
            const qB = document.getElementById(`proxy-quota-bar-${p.id}`);
            if(qU && p.quota_mb) {
                const pct = Math.min(100, (p.quota_used_mb/p.quota_mb)*100);
                qU.innerText = (p.quota_used_mb/1024).toFixed(2);
                document.getElementById(`proxy-quota-total-${p.id}`).innerText = (p.quota_mb/1024).toFixed(2);
                qB.style.width = pct+'%';
                qB.className = `progress-bar ${pct>90?'bg-danger':'bg-gradient-to-r from-blue-400 to-indigo-500'}`;
            }
        });
        applyFilter();
    });

    const updateHistory = () => fetch('/api/history').then(r=>r.json()).then(d => { trafChart.data.labels=d.labels; trafChart.data.datasets[0].data=d.download; trafChart.update(); });
    
    // Simple filter
    const applyFilter = () => {
        const s = document.getElementById('proxySearch').value.toLowerCase();
        const st = document.getElementById('proxyStatusFilter').value;
        document.querySelectorAll('#proxiesTable tbody tr').forEach(tr => {
            const txt = tr.innerText.toLowerCase();
            const stat = tr.querySelector('[data-proxy-status]')?.getAttribute('data-proxy-status');
            tr.style.display = (txt.includes(s) && (!st || stat===st)) ? '' : 'none';
        });
    };
    
    document.getElementById('proxySearch').addEventListener('input', applyFilter);
    document.getElementById('proxyStatusFilter').addEventListener('change', applyFilter);

    // Latency
    const updateLat = () => fetch('/api/latency').then(r=>r.json()).then(d => {
        const el = document.getElementById('latency-display');
        el.innerText = d.status==='success' ? d.latency+'ms' : 'Err';
        el.className = `fw-bold small font-mono ${d.latency<150?'text-success':(d.latency<400?'text-warning':'text-danger')}`;
    });

    // Country Chart
    let cChart = null;
    const updateCountryChart = () => fetch('/api/reports/top_ips').then(r=>r.json()).then(d => {
        document.getElementById('countryChartLoading').style.display = 'none';
        const ctx = document.getElementById('countryChart').getContext('2d');
        const labels = d.map(x=>x.country), vals = d.map(x=>x.connections);
        if(cChart) cChart.destroy();
        cChart = new Chart(ctx, { type:'doughnut', data:{labels, datasets:[{data:vals, backgroundColor:['#6366f1','#10b981','#f59e0b','#ef4444','#06b6d4'], borderWidth:0}]}, options:{responsive:true,maintainAspectRatio:false, cutout:'75%', plugins:{legend:{position:'right', labels:{color:'#94a3b8'}}}} });
    });

    // Loops
    setInterval(updateStats, 2000);
    setInterval(updateProxies, 5000);
    setInterval(updateLat, 10000);
    setInterval(updateHistory, 60000);
    updateStats(); updateProxies(); updateHistory(); updateLat();

    // Details Modal Logic (Simplified)
    let currId, connChart, useChart;
    const openProxyDetails = (id, port) => {
        currId = id; document.getElementById('detailsPort').innerText = port;
        new bootstrap.Modal(document.getElementById('proxyDetailsModal')).show();
        updateConnections(id);
        if(!connChart) connChart = new Chart(document.getElementById('connectionsChart'), { type:'line', data:{labels:[],datasets:[{data:[],borderColor:'#ef4444',backgroundColor:'rgba(239,68,68,0.1)',fill:true,tension:0.4}]}, options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{display:false},y:{grid:{color:'rgba(255,255,255,0.03)'}}}} });
        if(!useChart) useChart = new Chart(document.getElementById('usageChart'), { type:'bar', data:{labels:[],datasets:[{data:[],backgroundColor:'#10b981'}]}, options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{display:false},y:{grid:{color:'rgba(255,255,255,0.03)'}}}} });
        updateUsageHistory(id);
    };
    const updateConnections = (id) => {
        fetch(`/api/proxy/${id}/connections`).then(r=>r.json()).then(d => {
            document.getElementById('connectionsTable').innerHTML = d.items?.map(i=>`<tr><td class="font-mono text-info ps-3">${i.ip}</td><td>${i.country}</td><td class="font-mono text-muted">${i.connected_for}</td></tr>`).join('')||'<tr><td colspan="3" class="text-center text-muted py-3">خالی</td></tr>';
        });
        fetch(`/api/proxy/${id}/connections_history?minutes=60`).then(r=>r.json()).then(d => { if(connChart){connChart.data.labels=d.labels; connChart.data.datasets[0].data=d.values; connChart.update();} });
    };
    const updateUsageHistory = (id) => {
        fetch(`/api/proxy/${id}/usage_history?days=30`).then(r=>r.json()).then(d => { if(useChart){useChart.data.labels=d.labels; useChart.data.datasets[0].data=d.download_mb; useChart.update();} });
    };
</script>
{% endblock %}