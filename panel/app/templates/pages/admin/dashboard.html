{% extends "layouts/base.html" %}

{% block title %}داشبورد مدیریت | HoseinProxy{% endblock %}

{% block content %}
<!-- فونت وزیرمتن -->
<link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />

<style>
    :root {
        --bg-dark: #0f172a;
        --card-bg: rgba(30, 41, 59, 0.4);
        --card-border: rgba(255, 255, 255, 0.08);
        --card-hover-border: rgba(139, 92, 246, 0.3);
        --text-primary: #f8fafc;
        --text-secondary: #94a3b8;
        --accent-primary: #8b5cf6;
        --glass-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
    }

    body {
        font-family: 'Vazirmatn', sans-serif !important;
        background-color: var(--bg-dark) !important;
        color: var(--text-primary) !important;
        overflow-x: hidden;
    }

    #starfield {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        z-index: -1;
        background: radial-gradient(circle at top center, #1e293b 0%, #020617 80%);
        pointer-events: none;
    }

    /* استایل کارت‌ها */
    .glass-card {
        background: var(--card-bg);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid var(--card-border);
        border-radius: 16px;
        box-shadow: var(--glass-shadow);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        overflow: hidden;
    }
    .glass-card:hover {
        transform: translateY(-4px);
        border-color: var(--card-hover-border);
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
    }

    .card-header-clean {
        background: rgba(255, 255, 255, 0.03);
        border-bottom: 1px solid var(--card-border);
        padding: 1rem 1.5rem;
    }
    .card-body-clean { padding: 1.5rem; }

    /* دکمه‌های عملیات */
    .btn-action {
        width: 32px;
        height: 32px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        transition: all 0.2s;
        border: 1px solid transparent;
        color: white;
    }
    .btn-action:hover { transform: scale(1.1); }
    .btn-action-primary { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border-color: rgba(59, 130, 246, 0.3); }
    .btn-action-success { background: rgba(16, 185, 129, 0.2); color: #34d399; border-color: rgba(16, 185, 129, 0.3); }
    .btn-action-warning { background: rgba(245, 158, 11, 0.2); color: #fbbf24; border-color: rgba(245, 158, 11, 0.3); }
    .btn-action-danger  { background: rgba(239, 68, 68, 0.2); color: #f87171; border-color: rgba(239, 68, 68, 0.3); }
    .btn-action-info    { background: rgba(6, 182, 212, 0.2); color: #22d3ee; border-color: rgba(6, 182, 212, 0.3); }

    /* جدول واکنش‌گرا (تبدیل به کارت در موبایل) */
    .table-custom { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
    .table-custom thead th {
        background: transparent; color: var(--text-secondary); font-weight: 600; border: none; padding: 0 1rem 0.5rem 1rem;
    }
    .table-custom tbody tr { background: rgba(255, 255, 255, 0.02); transition: background 0.2s ease; }
    .table-custom tbody tr:hover { background: rgba(255, 255, 255, 0.05); }
    .table-custom td { border: none; padding: 1rem; vertical-align: middle; color: var(--text-primary); }
    .table-custom td:first-child { border-top-right-radius: 12px; border-bottom-right-radius: 12px; }
    .table-custom td:last-child { border-top-left-radius: 12px; border-bottom-left-radius: 12px; }

    @media (max-width: 991px) {
        .table-custom { display: block; }
        .table-custom thead { display: none; }
        .table-custom tbody { display: block; }
        .table-custom tbody tr {
            display: block;
            margin-bottom: 1rem;
            border: 1px solid var(--card-border);
            border-radius: 16px;
            padding: 1rem;
            background: rgba(30, 41, 59, 0.6);
        }
        .table-custom td {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            text-align: left;
        }
        .table-custom td:last-child { border-bottom: none; padding-bottom: 0; }
        .table-custom td:first-child { padding-top: 0; }
        .table-custom td::before {
            content: attr(data-label);
            float: right;
            font-weight: bold;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
    }

    /* سایر استایل‌ها */
    .icon-box { width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; border-radius: 12px; font-size: 1.25rem; }
    .form-control, .form-select {
        background-color: rgba(15, 23, 42, 0.8) !important;
        border: 1px solid var(--card-border) !important;
        color: #fff !important;
        border-radius: 10px;
    }
    .btn-glow-primary {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        border: none; color: white;
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
    }
    .status-badge { padding: 0.35em 0.8em; border-radius: 50rem; font-size: 0.75em; font-weight: 700; }
    .status-badge.running { background: rgba(16, 185, 129, 0.2); color: #34d399; }
    .status-badge.stopped { background: rgba(239, 68, 68, 0.2); color: #f87171; }
    
    .fade-in-up { animation: fadeInUp 0.6s ease-out forwards; opacity: 0; transform: translateY(20px); }
    @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
    .delay-1 { animation-delay: 0.1s; } .delay-2 { animation-delay: 0.2s; } .delay-3 { animation-delay: 0.3s; }
</style>

<canvas id="starfield"></canvas>

<div class="container-fluid py-4 px-lg-5">
    
    <!-- هدر -->
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 fade-in-up">
        <div>
            <h2 class="fw-bold text-white mb-1">داشبورد مدیریتی</h2>
            <p class="text-secondary mb-0">HoseinProxy Admin Panel</p>
        </div>
        <div class="glass-card px-4 py-2 d-flex align-items-center gap-4 mt-3 mt-md-0">
            <div class="d-flex align-items-center">
                <i class="fas fa-clock text-info me-2"></i>
                <span id="uptime-display" class="fw-bold text-white small">...</span>
            </div>
            <div class="vr bg-secondary opacity-25"></div>
            <div class="d-flex align-items-center">
                <i class="fas fa-tachometer-alt text-purple me-2"></i>
                <span id="load-avg-display" class="fw-bold text-white small font-monospace">-</span>
            </div>
        </div>
    </div>

    <!-- کارت‌های وضعیت -->
    <div class="row g-4 mb-4">
        <!-- CPU -->
        <div class="col-xl-3 col-md-6 fade-in-up delay-1">
            <div class="glass-card h-100 p-4">
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-secondary small">CPU Usage</span>
                    <i class="fas fa-microchip text-primary"></i>
                </div>
                <h2 class="mb-0 text-white fw-bold"><span id="cpu-usage">--</span><small class="fs-6 text-secondary">%</small></h2>
                <div class="progress mt-3 bg-dark bg-opacity-50" style="height: 4px;">
                    <div id="cpu-bar" class="progress-bar bg-primary" style="width: 0%"></div>
                </div>
            </div>
        </div>
        <!-- RAM -->
        <div class="col-xl-3 col-md-6 fade-in-up delay-1">
            <div class="glass-card h-100 p-4">
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-secondary small">RAM Usage</span>
                    <i class="fas fa-memory text-success"></i>
                </div>
                <h2 class="mb-0 text-white fw-bold"><span id="ram-usage">--</span><small class="fs-6 text-secondary">%</small></h2>
                <div class="progress mt-3 bg-dark bg-opacity-50" style="height: 4px;">
                    <div id="ram-bar" class="progress-bar bg-success" style="width: 0%"></div>
                </div>
            </div>
        </div>
        <!-- Network -->
        <div class="col-xl-3 col-md-6 fade-in-up delay-2">
            <div class="glass-card h-100 p-4">
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-secondary small">Network Speed</span>
                    <i class="fas fa-network-wired text-info"></i>
                </div>
                <h2 class="mb-0 text-white fw-bold font-monospace"><span id="net-down-speed">0</span><small class="fs-6 text-secondary ms-1">MB/s</small></h2>
                <div class="text-secondary small mt-2 text-end">Total: <span id="net-total-down" class="text-white fw-bold">--</span></div>
            </div>
        </div>
        <!-- Active Proxies -->
        <div class="col-xl-3 col-md-6 fade-in-up delay-2">
            <div class="glass-card h-100 p-4">
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-secondary small">Active Proxies</span>
                    <i class="fas fa-shield-alt text-warning"></i>
                </div>
                <h2 class="mb-0 text-white fw-bold">{{ proxies|selectattr('status', 'equalto', 'running')|list|length }} <small class="fs-6 text-secondary">/ {{ proxies|length }}</small></h2>
                <div class="d-flex gap-2 mt-2 align-items-center">
                    <span class="status-dot running"></span> <span class="small text-secondary">Running</span>
                </div>
            </div>
        </div>
    </div>

    <!-- نمودارها -->
    <div class="row g-4 mb-4 fade-in-up delay-3">
        <div class="col-lg-8">
            <div class="glass-card h-100 p-3">
                <div style="height: 250px;"><canvas id="systemChart"></canvas></div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="glass-card h-100 p-3">
                <div style="height: 250px;"><canvas id="trafficChart"></canvas></div>
            </div>
        </div>
    </div>

    <!-- لیست پروکسی‌ها -->
    <div class="glass-card fade-in-up delay-3 mb-5">
        <div class="card-header-clean d-flex flex-wrap justify-content-between align-items-center gap-3">
            <h5 class="mb-0 fw-bold text-white"><i class="fas fa-list me-2 text-primary"></i>لیست پروکسی‌ها</h5>
            <div class="d-flex gap-2 flex-wrap">
                <input id="proxySearch" type="text" class="form-control form-control-sm border-0" style="width: 200px;" placeholder="جستجو...">
                <button class="btn btn-glow-primary btn-sm rounded-pill px-3" data-bs-toggle="modal" data-bs-target="#addProxyModal">
                    <i class="fas fa-plus me-1"></i> جدید
                </button>
                 <button class="btn btn-outline-secondary btn-sm rounded-pill px-3" data-bs-toggle="modal" data-bs-target="#bulkCreateModal">
                    <i class="fas fa-layer-group"></i>
                </button>
            </div>
        </div>
        <div class="card-body-clean p-0">
            <div class="table-responsive px-3 pb-3">
                <table id="proxiesTable" class="table-custom">
                    <thead>
                        <tr>
                            <th>پورت</th>
                            <th>نام / تگ</th>
                            <th>وضعیت</th>
                            <th>کاربران</th>
                            <th>مصرف لحظه‌ای</th>
                            <th>حجم</th>
                            <th>لینک</th>
                            <th class="text-end">عملیات</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for proxy in proxies %}
                        <tr>
                            <td data-label="پورت" class="ps-3 fw-bold font-monospace text-info fs-5">{{ proxy.port }}</td>
                            <td data-label="نام / تگ">
                                <div class="d-flex flex-column">
                                    <span class="fw-bold text-white">{{ proxy.name or '-' }}</span>
                                    {% if proxy.tag %}<span class="badge bg-secondary bg-opacity-25 text-secondary fw-normal mt-1 w-auto align-self-start">{{ proxy.tag }}</span>{% endif %}
                                </div>
                            </td>
                            <td data-label="وضعیت">
                                {% if proxy.status == 'running' %}
                                    <span class="status-badge running">فعال</span>
                                {% else %}
                                    <span class="status-badge stopped">متوقف</span>
                                {% endif %}
                            </td>
                            <td data-label="کاربران">
                                <span class="badge bg-dark bg-opacity-50 text-white border border-secondary border-opacity-25 py-2 px-3 cursor-pointer" onclick="openProxyDetails({{ proxy.id|tojson }}, {{ proxy.port|tojson }})">
                                    <i class="fas fa-user me-1 text-secondary"></i> <span id="proxy-users-{{ proxy.id }}">{{ proxy.active_connections }}</span>
                                </span>
                            </td>
                            <td data-label="مصرف لحظه‌ای">
                                <span class="font-monospace fw-bold text-warning" id="proxy-download-rate-{{ proxy.id }}">0</span> <small class="text-secondary">MB/s</small>
                            </td>
                            <td data-label="حجم کل">
                                <div class="d-flex flex-column" style="min-width: 120px;">
                                    <div class="d-flex justify-content-between small mb-1">
                                        <span class="text-secondary" id="proxy-quota-used-{{ proxy.id }}">-</span>
                                        <span class="text-white fw-bold" id="proxy-quota-total-{{ proxy.id }}">- GB</span>
                                    </div>
                                    <div class="progress bg-dark bg-opacity-50" style="height: 4px;">
                                        <div id="proxy-quota-bar-{{ proxy.id }}" class="progress-bar rounded-pill bg-gradient-to-r from-green-400 to-emerald-500" style="width: 0%"></div>
                                    </div>
                                    {% if proxy.expiry_date %}
                                    <small class="text-secondary mt-1 {{ 'text-danger' if proxy.expiry_date < now else '' }}">{{ proxy.expiry_date.strftime('%Y-%m-%d') }}</small>
                                    {% endif %}
                                </div>
                            </td>
                            <td data-label="لینک اتصال">
                                <div class="d-flex gap-1">
                                    <button class="btn btn-action btn-action-info btn-sm" onclick="copyToClipboard({{ proxy.secret|tojson|forceescape }})"><i class="far fa-copy"></i></button>
                                    <button class="btn btn-action btn-action-info btn-sm" onclick="showLink('{{ proxy.port }}', {{ proxy.secret|tojson|forceescape }}, {{ proxy.proxy_ip|tojson|forceescape }})"><i class="fas fa-qrcode"></i></button>
                                </div>
                            </td>
                            <td data-label="عملیات" class="text-end">
                                <div class="d-flex gap-2 justify-content-end align-items-center">
                                    {% if proxy.status == 'running' %}
                                    <a href="{{ url_for('proxy.stop', id=proxy.id) }}" class="btn btn-action btn-action-danger" title="توقف"><i class="fas fa-pause"></i></a>
                                    {% else %}
                                    <a href="{{ url_for('proxy.start', id=proxy.id) }}" class="btn btn-action btn-action-success" title="شروع"><i class="fas fa-play"></i></a>
                                    {% endif %}
                                    
                                    <a href="{{ url_for('proxy.restart', id=proxy.id) }}" class="btn btn-action btn-action-warning" title="ریستارت"><i class="fas fa-sync-alt"></i></a>
                                    
                                    <button class="btn btn-action btn-action-primary" onclick="openProxyEdit({{ proxy.id|tojson }}, {{ proxy.port|tojson }}, {{ proxy.tag|tojson|forceescape }}, {{ ((proxy.quota_bytes / (1024*1024*1024))|round(2) if proxy.quota_bytes else 0)|tojson }}, {{ proxy.secret|tojson|forceescape }}, {{ proxy.status|tojson|forceescape }}, {{ proxy.username|tojson|forceescape }}, {{ proxy.password|tojson|forceescape }}, {{ proxy.proxy_ip|tojson|forceescape }}, {{ proxy.name|tojson|forceescape }})" title="ویرایش">
                                        <i class="fas fa-pen"></i>
                                    </button>
                                    
                                    <a href="{{ url_for('proxy.delete', id=proxy.id) }}" onclick="return confirm('آیا مطمئن هستید؟')" class="btn btn-action btn-action-danger" title="حذف">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="8" class="text-center py-5 text-secondary">هیچ پروکسی یافت نشد.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modals (همان کدهای قبلی با کمی تمیزکاری) -->
<!-- Add Proxy Modal -->
<div class="modal fade" id="addProxyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content glass-card border-0">
            <div class="modal-header border-bottom border-secondary border-opacity-10">
                <h5 class="modal-title text-white">افزودن پروکسی</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('proxy.add') }}" method="POST">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="text-secondary small">پورت</label>
                            <input type="number" name="port" class="form-control" required>
                        </div>
                         <div class="col-md-6">
                            <label class="text-secondary small">نوع</label>
                            <select name="proxy_type" id="proxyType" class="form-select" onchange="toggleProxyFields()">
                                <option value="standard">استاندارد</option>
                                <option value="dd">DD</option>
                                <option value="tls">TLS</option>
                            </select>
                        </div>
                        <div class="col-12"><input type="text" name="name" class="form-control" placeholder="نام نمایشی"></div>
                        <div class="col-12 d-none" id="tlsDomainField"><input type="text" name="tls_domain" class="form-control" value="google.com"></div>
                        <div class="col-12">
                            <div class="input-group">
                                <input type="text" name="secret" id="newSecret" class="form-control font-monospace" placeholder="Secret (خالی = خودکار)">
                                <button class="btn btn-outline-secondary" type="button" onclick="generateSecret()"><i class="fas fa-dice"></i></button>
                            </div>
                        </div>
                         <div class="col-md-6"><input type="number" name="quota_gb" class="form-control" placeholder="حجم (GB)"></div>
                         <div class="col-md-6"><input type="number" name="expiry_days" class="form-control" placeholder="روز اعتبار"></div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="submit" class="btn btn-glow-primary w-100">ایجاد</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Proxy Modal -->
<div class="modal fade" id="editProxyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content glass-card border-0">
            <div class="modal-header border-bottom border-secondary border-opacity-10">
                <h5 class="modal-title text-white">ویرایش پروکسی</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="editProxyForm" method="POST">
                <div class="modal-body">
                    <div class="alert alert-warning small bg-warning bg-opacity-10 text-warning border-0 p-2 mb-3 rounded">
                        <i class="fas fa-info-circle me-1"></i> تغییر پورت یا سکرت = ریستارت سرویس
                    </div>
                    <div class="row g-3">
                        <div class="col-md-6"><label class="small text-secondary">پورت</label><input type="number" name="port" id="editProxyPort" class="form-control" required></div>
                        <div class="col-md-6"><label class="small text-secondary">وضعیت</label>
                            <select name="status" id="editProxyStatus" class="form-select">
                                <option value="running">فعال</option>
                                <option value="stopped">متوقف</option>
                            </select>
                        </div>
                        <div class="col-12"><label class="small text-secondary">سکرت</label>
                            <div class="input-group">
                                <input type="text" name="secret" id="editProxySecret" class="form-control font-monospace">
                                <button class="btn btn-outline-secondary" type="button" onclick="document.getElementById('editProxySecret').value = generateRandomHex()"><i class="fas fa-sync"></i></button>
                            </div>
                        </div>
                        <div class="col-12"><label class="small text-secondary">نام</label><input type="text" name="name" id="editProxyName" class="form-control"></div>
                        <div class="col-md-6"><label class="small text-secondary">حجم (GB)</label><input type="number" name="quota_gb" id="editProxyQuota" class="form-control"></div>
                        <div class="col-md-6"><label class="small text-secondary">تمدید (روز)</label><input type="number" name="expiry_days" id="editProxyExpiry" class="form-control"></div>
                        <input type="hidden" name="proxy_ip" id="editProxyIP">
                        <input type="hidden" name="tag" id="editProxyTag">
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="submit" class="btn btn-glow-primary w-100">ذخیره تغییرات</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bulk Create Modal -->
<div class="modal fade" id="bulkCreateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content glass-card border-0">
            <div class="modal-header border-bottom border-secondary border-opacity-10">
                <h5 class="modal-title text-white">ساخت گروهی</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('proxy.bulk_create') }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3"><label class="text-secondary small">پورت شروع</label><input type="number" name="start_port" class="form-control" required placeholder="20000"></div>
                    <div class="mb-3"><label class="text-secondary small">تعداد</label><input type="number" name="count" class="form-control" value="10"></div>
                    <div class="mb-3"><label class="text-secondary small">پیشوند نام</label><input type="text" name="name_prefix" class="form-control" placeholder="کاربر"></div>
                </div>
                <div class="modal-footer border-0">
                    <button type="submit" class="btn btn-glow-primary w-100">شروع عملیات</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Details Modal -->
<div class="modal fade" id="proxyDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content glass-card border-0">
            <div class="modal-header border-bottom border-secondary border-opacity-10">
                <h5 class="modal-title text-white">جزئیات <span id="detailsPort" class="text-info font-monospace mx-2"></span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-4">
                    <div class="col-lg-12">
                        <div class="card bg-transparent border border-secondary border-opacity-10">
                            <div class="card-header border-0 py-2"><h6 class="mb-0 text-white small">اتصالات زنده</h6></div>
                            <div class="card-body p-0">
                                <div class="table-responsive" style="max-height: 200px;">
                                    <table class="table table-sm table-dark mb-0 bg-transparent">
                                        <tbody id="connectionsTable"><tr><td class="text-center text-secondary small">در حال بارگذاری...</td></tr></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-12">
                         <div style="height: 200px;"><canvas id="connectionsChart"></canvas></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // --- Starfield Background ---
    const canvas = document.getElementById('starfield');
    const ctx = canvas.getContext('2d');
    let width, height, stars = [];
    const resizeCanvas = () => { width = window.innerWidth; height = window.innerHeight; canvas.width = width; canvas.height = height; };
    class Star {
        constructor() { this.reset(); }
        reset() { this.x = Math.random()*width; this.y = Math.random()*height; this.size = Math.random()*1.5+0.5; this.speed = Math.random()*0.1+0.02; this.opacity = Math.random()*0.8; }
        update() { this.y -= this.speed; if(this.y<0) this.reset(); }
        draw() { ctx.fillStyle = `rgba(255,255,255,${this.opacity})`; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fill(); }
    }
    const initStars = () => { stars = Array.from({length:100}, () => new Star()); };
    const animateStars = () => { ctx.clearRect(0,0,width,height); stars.forEach(s => { s.update(); s.draw(); }); requestAnimationFrame(animateStars); };
    window.addEventListener('resize', () => { resizeCanvas(); initStars(); });
    resizeCanvas(); initStars(); animateStars();

    // --- Core Logic ---
    const copyToClipboard = (text) => { navigator.clipboard.writeText(text); Swal.fire({toast:true, position:'bottom', icon:'success', title:'کپی شد', showConfirmButton:false, timer:1500, background:'#1e293b', color:'#fff'}); };
    const generateSecret = () => {
        const type = document.getElementById('proxyType').value;
        if(type==='tls') { document.getElementById('newSecret').value=''; return; }
        let sec = [...Array(32)].map(()=>Math.floor(Math.random()*16).toString(16)).join('');
        document.getElementById('newSecret').value = type==='dd' ? 'dd'+sec : sec;
    };
    const generateRandomHex = () => [...Array(32)].map(()=>Math.floor(Math.random()*16).toString(16)).join('');
    const toggleProxyFields = () => { document.getElementById('tlsDomainField').classList.toggle('d-none', document.getElementById('proxyType').value !== 'tls'); };
    
    function showLink(port, secret, proxyIp) {
        const link = `tg://proxy?server=${proxyIp||'{{ server_ip }}'||window.location.hostname}&port=${port}&secret=${secret}`;
        Swal.fire({
            html: `<div class="mb-3"><input class="form-control bg-dark text-white text-center font-monospace" value="${link}" readonly></div><a href="${link}" class="btn btn-primary w-100">اتصال</a>`,
            background: '#0f172a', showConfirmButton: false, showCloseButton: true
        });
    }

    // --- Charts & Data ---
    Chart.defaults.font.family = 'Vazirmatn'; Chart.defaults.color = '#94a3b8'; Chart.defaults.borderColor = 'rgba(255,255,255,0.05)';
    const sysChart = new Chart(document.getElementById('systemChart'), {
        type: 'line', data: { labels: Array(20).fill(''), datasets: [{ label:'CPU', data:Array(20).fill(0), borderColor:'#8b5cf6', backgroundColor:'rgba(139,92,246,0.1)', fill:true, tension:0.4, pointRadius:0 }, { label:'RAM', data:Array(20).fill(0), borderColor:'#10b981', tension:0.4, pointRadius:0 }] },
        options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{beginAtZero:true, max:100}} }
    });
    const trafChart = new Chart(document.getElementById('trafficChart'), {
        type: 'bar', data: { labels:[], datasets:[{ label:'GB', data:[], backgroundColor:'#06b6d4', borderRadius:4 }] },
        options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{grid:{display:false}}} }
    });
    
    let currentProxyId, connChart;
    
    // Data Fetchers
    const updateStats = () => fetch('/api/stats').then(r=>r.json()).then(d => {
        document.getElementById('cpu-usage').innerText = d.cpu; document.getElementById('ram-usage').innerText = d.mem_percent;
        document.getElementById('cpu-bar').style.width = d.cpu+'%'; document.getElementById('ram-bar').style.width = d.mem_percent+'%';
        document.getElementById('net-total-down').innerText = Math.round(d.net_recv/1024)+' GB';
        sysChart.data.datasets[0].data.push(d.cpu); sysChart.data.datasets[0].data.shift();
        sysChart.data.datasets[1].data.push(d.mem_percent); sysChart.data.datasets[1].data.shift();
        sysChart.update();
    });
    
    const updateProxies = () => fetch('/api/proxies').then(r=>r.json()).then(d => {
        d.forEach(p => {
            const els = { u:document.getElementById(`proxy-users-${p.id}`), r:document.getElementById(`proxy-download-rate-${p.id}`), qU:document.getElementById(`proxy-quota-used-${p.id}`), qT:document.getElementById(`proxy-quota-total-${p.id}`), qB:document.getElementById(`proxy-quota-bar-${p.id}`) };
            if(els.u) els.u.innerText = p.active_connections;
            if(els.r) els.r.innerText = p.download_rate_mbps||0;
            if(p.quota_mb && els.qU) {
                els.qU.innerText = (p.quota_used_mb/1024).toFixed(2); els.qT.innerText = (p.quota_mb/1024).toFixed(2);
                els.qB.style.width = Math.min(100, (p.quota_used_mb/p.quota_mb)*100)+'%';
            }
        });
    });

    const openProxyEdit = (id, port, tag, quota, secret, status, user, pass, ip, name) => {
        const form = document.getElementById('editProxyForm'); form.action = `/proxy/update/${id}`;
        document.getElementById('editProxyPort').value = port;
        document.getElementById('editProxyName').value = name||'';
        document.getElementById('editProxySecret').value = secret;
        document.getElementById('editProxyQuota').value = quota||'';
        document.getElementById('editProxyStatus').value = status;
        new bootstrap.Modal(document.getElementById('editProxyModal')).show();
    };

    const openProxyDetails = (id, port) => {
        currentProxyId = id; document.getElementById('detailsPort').innerText = port;
        new bootstrap.Modal(document.getElementById('proxyDetailsModal')).show();
        updateConnections(id);
        if(!connChart) connChart = new Chart(document.getElementById('connectionsChart'), { type:'line', data:{labels:[], datasets:[{data:[], borderColor:'#ef4444', backgroundColor:'rgba(239,68,68,0.2)', fill:true, tension:0.4, pointRadius:0}]}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{display:false}}} });
    };

    const updateConnections = (id) => fetch(`/api/proxy/${id}/connections`).then(r=>r.json()).then(d => {
        document.getElementById('connectionsTable').innerHTML = d.items?.length ? d.items.map(i=>`<tr><td class="font-monospace text-info">${i.ip}</td><td class="text-white small">${i.country||'-'}</td></tr>`).join('') : '<tr><td class="text-center text-muted small">خالی</td></tr>';
    });

    setInterval(updateStats, 2000); setInterval(updateProxies, 5000);
    updateStats(); updateProxies();
</script>
{% endblock %}