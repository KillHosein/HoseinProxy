{% extends "layouts/base.html" %}

{% block title %}داشبورد مدیریت | HoseinProxy{% endblock %}

{% block content %}
<!-- فونت وزیرمتن -->
<link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />

<style>
    :root {
        --bg-dark: #0f172a;
        --card-bg: rgba(30, 41, 59, 0.4);
        --card-border: rgba(255, 255, 255, 0.06);
        --card-hover-border: rgba(124, 58, 237, 0.3);
        --text-primary: #f8fafc;
        --text-secondary: #94a3b8;
        --accent-primary: #8b5cf6;
        --accent-glow: rgba(139, 92, 246, 0.25);
        --success: #10b981;
        --danger: #ef4444;
        --warning: #f59e0b;
        --info: #06b6d4;
        --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    }

    body {
        font-family: 'Vazirmatn', system-ui, -apple-system, sans-serif !important;
        background-color: var(--bg-dark) !important;
        color: var(--text-primary) !important;
        overflow-x: hidden;
        letter-spacing: -0.015em;
    }

    /* Cinematic Background */
    #starfield {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        z-index: -1;
        background: radial-gradient(circle at 50% 0%, #1e293b 0%, #020617 80%);
        pointer-events: none;
    }

    /* Ultra-Modern Glass Card */
    .glass-card {
        background: var(--card-bg);
        backdrop-filter: blur(24px);
        -webkit-backdrop-filter: blur(24px);
        border: 1px solid var(--card-border);
        border-top: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 24px;
        box-shadow: var(--glass-shadow);
        transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        overflow: hidden;
        position: relative;
    }
    
    .glass-card::before {
        content: '';
        position: absolute;
        inset: 0;
        background: radial-gradient(800px circle at var(--mouse-x, 50%) var(--mouse-y, 0%), rgba(255,255,255,0.04), transparent 40%);
        opacity: 0;
        transition: opacity 0.5s;
        pointer-events: none;
        z-index: 1;
    }

    .glass-card:hover {
        transform: translateY(-4px) scale(1.005);
        border-color: var(--card-hover-border);
        box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.5);
    }
    
    .glass-card:hover::before {
        opacity: 1;
    }

    .card-header-clean {
        background: rgba(255, 255, 255, 0.02);
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        padding: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .card-body-clean { padding: 1.5rem; }

    /* Action Buttons */
    .btn-action {
        width: 36px; height: 36px;
        display: inline-flex; align-items: center; justify-content: center;
        border-radius: 12px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid transparent;
        color: white; text-decoration: none;
        background: rgba(255, 255, 255, 0.05);
        font-size: 0.95rem;
    }
    .btn-action:hover { transform: translateY(-3px); filter: brightness(1.2); }
    
    .btn-action-primary { background: rgba(59, 130, 246, 0.1); color: #93c5fd; border-color: rgba(59, 130, 246, 0.2); }
    .btn-action-primary:hover { background: rgba(59, 130, 246, 0.2); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }

    .btn-action-success { background: rgba(16, 185, 129, 0.1); color: #6ee7b7; border-color: rgba(16, 185, 129, 0.2); }
    .btn-action-success:hover { background: rgba(16, 185, 129, 0.2); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }

    .btn-action-warning { background: rgba(245, 158, 11, 0.1); color: #fcd34d; border-color: rgba(245, 158, 11, 0.2); }
    .btn-action-warning:hover { background: rgba(245, 158, 11, 0.2); box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3); }

    .btn-action-danger  { background: rgba(239, 68, 68, 0.1); color: #fca5a5; border-color: rgba(239, 68, 68, 0.2); }
    .btn-action-danger:hover { background: rgba(239, 68, 68, 0.2); box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3); }

    .btn-action-info    { background: rgba(6, 182, 212, 0.1); color: #67e8f9; border-color: rgba(6, 182, 212, 0.2); }
    .btn-action-info:hover { background: rgba(6, 182, 212, 0.2); box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3); }

    /* Modern Table */
    .table-responsive { overflow-x: auto; border-radius: 16px; }
    .table-custom { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
    
    .table-custom thead th {
        background: transparent;
        color: var(--text-secondary);
        font-weight: 700;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        padding: 0 1.5rem 1rem 1.5rem;
        border: none;
    }
    
    .table-custom tbody tr {
        background: rgba(30, 41, 59, 0.3);
        transition: all 0.3s ease;
        position: relative;
    }
    
    .table-custom tbody tr:hover {
        background: rgba(45, 55, 72, 0.5);
        transform: scale(1.005);
        box-shadow: 0 10px 25px -5px rgba(0,0,0,0.2);
        z-index: 10;
    }
    
    .table-custom td {
        padding: 1.25rem 1.5rem;
        vertical-align: middle;
        border-top: 1px solid rgba(255,255,255,0.02);
        border-bottom: 1px solid rgba(255,255,255,0.02);
        color: var(--text-primary);
    }
    
    .table-custom td:first-child { border-top-right-radius: 16px; border-bottom-right-radius: 16px; border-right: 1px solid rgba(255,255,255,0.03); border-left: none; }
    .table-custom td:last-child { border-top-left-radius: 16px; border-bottom-left-radius: 16px; border-left: 1px solid rgba(255,255,255,0.03); border-right: none; }

    /* Status Badge */
    .status-badge {
        padding: 0.5em 1em;
        border-radius: 999px;
        font-weight: 700;
        font-size: 0.75rem;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        position: relative;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    .status-badge::before {
        content: ''; width: 6px; height: 6px; border-radius: 50%;
        background-color: currentColor;
        box-shadow: 0 0 10px currentColor;
    }
    .status-badge.running { 
        background: rgba(16, 185, 129, 0.1); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.2);
    }
    .status-badge.running::before { animation: pulse-green 2s infinite; }
    
    .status-badge.stopped { 
        background: rgba(239, 68, 68, 0.1); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.2);
    }

    @keyframes pulse-green {
        0% { box-shadow: 0 0 0 0 rgba(52, 211, 153, 0.7); }
        70% { box-shadow: 0 0 0 8px rgba(52, 211, 153, 0); }
        100% { box-shadow: 0 0 0 0 rgba(52, 211, 153, 0); }
    }

    /* Glow Button */
    .btn-glow-primary {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        border: none; color: white;
        box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
        transition: all 0.3s ease;
        border-radius: 14px;
        padding: 0.7rem 1.5rem;
        font-weight: 600;
        position: relative;
        overflow: hidden;
    }
    .btn-glow-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 30px rgba(99, 102, 241, 0.6);
    }
    .btn-glow-primary::after {
        content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        transition: 0.5s;
    }
    .btn-glow-primary:hover::after { left: 100%; }

    /* Inputs */
    .form-control, .form-select {
        background-color: rgba(15, 23, 42, 0.6) !important;
        border: 1px solid rgba(255, 255, 255, 0.1) !important;
        color: #f1f5f9 !important;
        border-radius: 12px;
        padding: 0.75rem 1rem;
        transition: all 0.3s ease;
    }
    .form-control:focus, .form-select:focus {
        background-color: rgba(15, 23, 42, 0.8) !important;
        border-color: #8b5cf6 !important;
        box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.15) !important;
    }
    .form-control::placeholder { color: rgba(148, 163, 184, 0.5); }

    /* Animations */
    .fade-in-up { animation: fadeInUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; opacity: 0; transform: translateY(30px); }
    @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
    .delay-1 { animation-delay: 0.1s; } 
    .delay-2 { animation-delay: 0.2s; } 
    .delay-3 { animation-delay: 0.3s; }

    /* Sparklines Container */
    .sparkline-container {
        position: absolute; bottom: 0; left: 0; width: 100%; height: 60px;
        opacity: 0.3; pointer-events: none;
        mask-image: linear-gradient(to top, black, transparent);
        -webkit-mask-image: linear-gradient(to top, black, transparent);
        transition: opacity 0.3s;
    }
    .glass-card:hover .sparkline-container { opacity: 0.5; }

    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.2); }

    @media (max-width: 991px) {
        .table-custom { display: block; }
        .table-custom thead { display: none; }
        .table-custom tbody { display: grid; gap: 1rem; }
        .table-custom tbody tr {
            display: flex; flex-direction: column;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px; padding: 1.5rem;
            background: rgba(30, 41, 59, 0.5);
        }
        .table-custom td {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.75rem 0; border: none; border-bottom: 1px solid rgba(255,255,255,0.05);
            width: 100%;
        }
        .table-custom td:last-child { border-bottom: none; justify-content: center; margin-top: 1rem; }
        .table-custom td::before {
            content: attr(data-label); font-weight: 600; color: var(--text-secondary); font-size: 0.9rem;
        }
    }
</style>

<canvas id="starfield"></canvas>

<div class="container-fluid py-4 px-lg-5">
    
    <!-- Header -->
    <div class="d-flex flex-wrap justify-content-between align-items-end mb-5 fade-in-up">
        <div>
            <h1 class="fw-bold text-white mb-2" style="font-size: 2.5rem; letter-spacing: -1px;">داشبورد مدیریتی</h1>
            <p class="text-secondary mb-0 d-flex align-items-center gap-2">
                <span class="d-inline-block bg-success rounded-circle" style="width: 8px; height: 8px;"></span>
                سیستم در وضعیت پایدار است
            </p>
        </div>
        
        <div class="d-flex gap-3 align-items-center mt-4 mt-lg-0">
            <div class="glass-card px-4 py-3 d-flex align-items-center gap-4">
                <div class="text-center">
                    <div class="text-secondary small fw-bold mb-1" style="font-size: 0.65rem; letter-spacing: 1px;">UPTIME</div>
                    <div id="uptime-display" class="fw-bold text-white font-monospace">...</div>
                </div>
                <div class="vr bg-white opacity-10" style="height: 30px;"></div>
                <div class="text-center">
                    <div class="text-secondary small fw-bold mb-1" style="font-size: 0.65rem; letter-spacing: 1px;">LOAD</div>
                    <div id="load-avg-display" class="fw-bold text-info font-monospace">...</div>
                </div>
                <div class="vr bg-white opacity-10" style="height: 30px;"></div>
                <div class="text-center">
                    <div class="text-secondary small fw-bold mb-1" style="font-size: 0.65rem; letter-spacing: 1px;">PING</div>
                    <div id="latency-display" class="fw-bold text-warning font-monospace">--</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Cards -->
    <div class="row g-4 mb-5">
        <!-- CPU Card -->
        <div class="col-xl-3 col-md-6 fade-in-up delay-1">
            <div class="glass-card h-100 p-4 position-relative overflow-hidden group">
                <div class="d-flex justify-content-between align-items-start mb-4 position-relative z-1">
                    <div>
                        <span class="text-secondary fw-bold" style="font-size: 0.75rem; letter-spacing: 1px;">CPU USAGE</span>
                        <h2 class="mt-2 mb-0 text-white fw-bold font-monospace display-5"><span id="cpu-usage">--</span><small class="fs-4 text-secondary ms-1">%</small></h2>
                    </div>
                    <div class="bg-primary bg-opacity-10 text-primary p-3 rounded-4 shadow-sm">
                        <i class="fas fa-microchip fs-4"></i>
                    </div>
                </div>
                <div class="progress bg-dark bg-opacity-50 position-relative z-1" style="height: 6px; border-radius: 4px;">
                    <div id="cpu-bar" class="progress-bar bg-primary" style="width: 0%; border-radius: 4px; box-shadow: 0 0 10px rgba(59,130,246,0.5);"></div>
                </div>
                <!-- Sparkline -->
                <div class="sparkline-container">
                    <canvas id="sparkCpu"></canvas>
                </div>
            </div>
        </div>

        <!-- RAM Card -->
        <div class="col-xl-3 col-md-6 fade-in-up delay-1">
            <div class="glass-card h-100 p-4 position-relative overflow-hidden">
                <div class="d-flex justify-content-between align-items-start mb-4 position-relative z-1">
                    <div>
                        <span class="text-secondary fw-bold" style="font-size: 0.75rem; letter-spacing: 1px;">RAM USAGE</span>
                        <h2 class="mt-2 mb-0 text-white fw-bold font-monospace display-5"><span id="ram-usage">--</span><small class="fs-4 text-secondary ms-1">%</small></h2>
                    </div>
                    <div class="bg-success bg-opacity-10 text-success p-3 rounded-4 shadow-sm">
                        <i class="fas fa-memory fs-4"></i>
                    </div>
                </div>
                <div class="d-flex justify-content-between small text-secondary position-relative z-1">
                    <span id="ram-used">--</span> <span class="opacity-50">/</span> <span id="ram-total">--</span> <span class="opacity-75">GB</span>
                </div>
                <div class="sparkline-container">
                    <canvas id="sparkRam"></canvas>
                </div>
            </div>
        </div>

        <!-- Network Card -->
        <div class="col-xl-3 col-md-6 fade-in-up delay-2">
            <div class="glass-card h-100 p-4 position-relative overflow-hidden">
                <div class="d-flex justify-content-between align-items-start mb-4 position-relative z-1">
                    <div>
                        <span class="text-secondary fw-bold" style="font-size: 0.75rem; letter-spacing: 1px;">NETWORK</span>
                        <h2 class="mt-2 mb-0 text-white fw-bold font-monospace display-6" style="line-height: 1.2;">
                            <span id="net-down-speed">0</span>
                        </h2>
                    </div>
                    <div class="bg-info bg-opacity-10 text-info p-3 rounded-4 shadow-sm">
                        <i class="fas fa-network-wired fs-4"></i>
                    </div>
                </div>
                <div class="text-secondary small position-relative z-1 text-end fw-medium">Total: <span id="net-total-down" class="text-white">--</span></div>
                <div class="sparkline-container">
                    <canvas id="sparkNet"></canvas>
                </div>
            </div>
        </div>

        <!-- Active Proxies Card -->
        <div class="col-xl-3 col-md-6 fade-in-up delay-2">
            <div class="glass-card h-100 p-4 position-relative overflow-hidden">
                <div class="d-flex justify-content-between align-items-start mb-3 position-relative z-1">
                    <div>
                        <span class="text-secondary fw-bold" style="font-size: 0.75rem; letter-spacing: 1px;">PROXIES</span>
                        <h2 class="mt-2 mb-0 text-white fw-bold font-monospace display-5">{{ proxies|selectattr('status', 'equalto', 'running')|list|length }}</h2>
                    </div>
                    <div class="bg-warning bg-opacity-10 text-warning p-3 rounded-4 shadow-sm">
                        <i class="fas fa-shield-alt fs-4"></i>
                    </div>
                </div>
                
                <div class="position-relative z-1">
                    <div class="progress bg-dark bg-opacity-50" style="height: 6px; border-radius: 4px; overflow: hidden;">
                        {% set running_count = proxies|selectattr('status', 'equalto', 'running')|list|length %}
                        {% set stopped_count = proxies|selectattr('status', 'equalto', 'stopped')|list|length %}
                        {% set total_count = proxies|length %}
                        {% if total_count > 0 %}
                            {% set running_pct = (running_count / total_count * 100)|round(1) %}
                            {% set stopped_pct = (stopped_count / total_count * 100)|round(1) %}
                        {% else %}
                            {% set running_pct = 0 %}
                            {% set stopped_pct = 0 %}
                        {% endif %}
                        <div class="progress-bar bg-success init-width" role="progressbar" style="width: 0%; box-shadow: 0 0 10px rgba(16,185,129,0.5);" data-width="{{ running_pct }}%"></div>
                        <div class="progress-bar bg-danger init-width" role="progressbar" style="width: 0%" data-width="{{ stopped_pct }}%"></div>
                    </div>
                    <div class="d-flex justify-content-between small text-secondary mt-2 fw-medium" style="font-size: 0.75rem;">
                         <span><i class="fas fa-circle text-success me-1" style="font-size: 6px;"></i>Active: {{ running_count }}</span>
                         <span><i class="fas fa-circle text-danger me-1" style="font-size: 6px;"></i>Stopped: {{ stopped_count }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Charts Area -->
    <div class="row g-4 mb-5 fade-in-up delay-3">
        <div class="col-lg-8">
            <div class="glass-card h-100 p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h5 class="text-white fw-bold mb-1">مانیتورینگ منابع</h5>
                        <span class="text-secondary small">عملکرد لحظه‌ای سرور</span>
                    </div>
                    <div class="d-flex gap-2">
                        <span class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25 px-3 py-2 rounded-pill">CPU</span>
                        <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 px-3 py-2 rounded-pill">RAM</span>
                    </div>
                </div>
                <div style="height: 350px;"><canvas id="systemChart"></canvas></div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="glass-card h-100 p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <ul class="nav nav-pills nav-fill p-1 bg-dark bg-opacity-50 rounded-4 w-100" id="trafficTabs" role="tablist" style="font-size: 0.85rem;">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active py-2 rounded-4 text-white fw-bold" id="tab-traffic" data-bs-toggle="tab" data-bs-target="#content-traffic" type="button">ترافیک</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link py-2 rounded-4 text-white fw-bold" id="tab-countries" data-bs-toggle="tab" data-bs-target="#content-countries" type="button" onclick="updateCountryChart()">کشورها</button>
                        </li>
                    </ul>
                </div>
                <div class="tab-content h-100">
                    <div class="tab-pane fade show active h-100" id="content-traffic">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                             <span class="text-secondary small fw-bold">نمودار مصرف دیتا</span>
                             <button class="btn btn-sm btn-link text-secondary p-0" onclick="updateTrafficHistory()"><i class="fas fa-sync-alt"></i></button>
                        </div>
                        <div style="height: 280px;"><canvas id="trafficChart"></canvas></div>
                    </div>
                    <div class="tab-pane fade h-100" id="content-countries">
                        <div style="height: 280px; position: relative;">
                            <canvas id="countryChart"></canvas>
                            <div id="countryChartLoading" class="position-absolute top-50 start-50 translate-middle text-secondary small">در حال بارگذاری...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Proxy List -->
    <div class="glass-card fade-in-up delay-3 mb-5">
        <div class="card-header-clean">
            <div class="d-flex align-items-center gap-3">
                <div class="p-2 rounded-3 shadow-lg" style="background: linear-gradient(135deg, #6366f1, #8b5cf6);">
                    <i class="fas fa-list text-white"></i>
                </div>
                <div>
                    <h5 class="mb-0 fw-bold text-white">لیست پروکسی‌ها</h5>
                    <span class="text-secondary small" style="font-size: 0.75rem;">مدیریت کانکشن‌ها و کاربران</span>
                </div>
            </div>
            
            <div class="d-flex gap-2 flex-wrap align-items-center">
                <div class="position-relative">
                    <i class="fas fa-search text-secondary position-absolute top-50 translate-middle-y end-0 me-3 opacity-50"></i>
                    <input id="proxySearch" type="text" class="form-control form-control-sm ps-3 pe-5" placeholder="جستجو..." style="width: 220px; background: rgba(0,0,0,0.2);">
                </div>
                
                <select id="proxyStatusFilter" class="form-select form-select-sm" style="width: 140px; background: rgba(0,0,0,0.2);">
                    <option value="">همه وضعیت‌ها</option>
                    <option value="running">فقط فعال</option>
                    <option value="stopped">فقط متوقف</option>
                </select>
                
                <div class="vr bg-secondary opacity-25 mx-1 h-50 my-auto"></div>

                <button class="btn btn-outline-secondary btn-sm d-flex align-items-center gap-2 rounded-3 px-3" data-bs-toggle="modal" data-bs-target="#bulkCreateModal">
                    <i class="fas fa-layer-group"></i> <span class="d-none d-md-inline">گروهی</span>
                </button>
                
                <button class="btn btn-glow-primary btn-sm rounded-3 px-3 py-2 d-flex align-items-center gap-2" data-bs-toggle="modal" data-bs-target="#addProxyModal">
                    <i class="fas fa-plus"></i> <span class="d-none d-md-inline">پروکسی جدید</span>
                </button>
            </div>
        </div>

        <div class="card-body-clean p-0">
            <div class="table-responsive px-4 pb-4">
                <table id="proxiesTable" class="table-custom">
                    <thead>
                        <tr>
                            <th class="ps-4">پورت</th>
                            <th>نام / تگ</th>
                            <th>وضعیت</th>
                            <th>اتصالات</th>
                            <th>سرعت</th>
                            <th>حجم مصرفی</th>
                            <th class="text-center">لینک</th>
                            <th class="text-end pe-4">مدیریت</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for proxy in proxies %}
                        <tr>
                            <td data-label="پورت" data-proxy-port="{{ proxy.port }}" class="ps-4">
                                <div class="d-flex align-items-center gap-3">
                                    <div class="bg-dark bg-opacity-50 p-2 rounded-3 border border-secondary border-opacity-10">
                                        <i class="fas fa-ethernet text-secondary"></i>
                                    </div>
                                    <span class="font-monospace fw-bold text-white fs-5" style="letter-spacing: 1px;">{{ proxy.port }}</span>
                                </div>
                            </td>
                            
                            <td data-label="نام / تگ">
                                <div class="d-flex flex-column">
                                    <span class="fw-bold text-white mb-1">{{ proxy.name or '-' }}</span>
                                    {% if proxy.tag %}
                                    <span class="badge bg-dark border border-secondary border-opacity-25 text-secondary fw-normal w-auto align-self-start py-1 px-2 rounded-2" data-proxy-tag="{{ proxy.tag }}">
                                        <i class="fas fa-tag me-1 small opacity-50"></i> {{ proxy.tag }}
                                    </span>
                                    {% endif %}
                                </div>
                            </td>
                            
                            <td data-label="وضعیت">
                                {% if proxy.status == 'running' %}
                                    <span class="status-badge running" data-proxy-status="running">Active</span>
                                {% else %}
                                    <span class="status-badge stopped" data-proxy-status="stopped">Stopped</span>
                                {% endif %}
                            </td>
                            
                            <td data-label="اتصالات">
                                <div class="d-flex align-items-center gap-2 cursor-pointer p-2 rounded-3 hover-bg-light transition-all" onclick="openProxyDetails(this.dataset.id, this.dataset.port)" data-id="{{ proxy.id }}" data-port="{{ proxy.port }}" role="button" title="مشاهده جزئیات">
                                    <i class="fas fa-users text-info small"></i>
                                    <span class="text-white fw-bold font-monospace" id="proxy-users-{{ proxy.id }}">{{ proxy.active_connections }}</span>
                                </div>
                            </td>
                            
                            <td data-label="سرعت">
                                <span class="font-monospace text-warning small fw-bold" id="proxy-download-rate-{{ proxy.id }}">0 B/s</span>
                            </td>
                            
                            <td data-label="حجم" style="min-width: 160px;">
                                <div class="d-flex justify-content-between small mb-1">
                                    <span class="text-secondary small" id="proxy-quota-used-{{ proxy.id }}">-</span>
                                    <span class="text-white fw-bold small" id="proxy-quota-total-{{ proxy.id }}">-</span>
                                </div>
                                <div class="progress bg-dark bg-opacity-50 rounded-pill" style="height: 6px;">
                                    <div id="proxy-quota-bar-{{ proxy.id }}" class="progress-bar rounded-pill" style="width: 0%; background: linear-gradient(to right, #4ade80, #10b981); box-shadow: 0 0 10px rgba(16, 185, 129, 0.3);"></div>
                                </div>
                                {% if proxy.expiry_date %}
                                <div class="mt-2 d-flex align-items-center gap-1 text-secondary" style="font-size: 0.7rem;">
                                    <i class="far fa-clock"></i>
                                    <span class="{{ 'text-danger fw-bold' if proxy.expiry_date < now else '' }}">{{ proxy.expiry_date.strftime('%Y-%m-%d') }}</span>
                                </div>
                                {% endif %}
                            </td>
                            
                            <td data-label="لینک" class="text-center">
                                <div class="d-flex gap-2 justify-content-center">
                                    <button class="btn btn-action btn-action-info" onclick="copyProxyLink(this.dataset.port, this.dataset.secret, this.dataset.ip)" data-port="{{ proxy.port }}" data-secret="{{ proxy.display_secret }}" data-ip="{{ proxy.proxy_ip or '' }}" title="کپی لینک">
                                        <i class="far fa-copy"></i>
                                    </button>
                                    <button class="btn btn-action btn-action-info" onclick="showLink(this.dataset.port, this.dataset.secret, this.dataset.ip)" data-port="{{ proxy.port }}" data-secret="{{ proxy.display_secret }}" data-ip="{{ proxy.proxy_ip or '' }}" title="نمایش QR">
                                        <i class="fas fa-qrcode"></i>
                                    </button>
                                </div>
                            </td>
                            
                            <td data-label="مدیریت" class="text-end pe-4">
                                <div class="d-flex gap-2 justify-content-end">
                                    {% if proxy.status == 'running' %}
                                    <a href="{{ url_for('proxy.stop', id=proxy.id) }}" class="btn btn-action btn-action-danger" title="توقف">
                                        <i class="fas fa-pause"></i>
                                    </a>
                                    {% else %}
                                    <a href="{{ url_for('proxy.start', id=proxy.id) }}" class="btn btn-action btn-action-success" title="شروع">
                                        <i class="fas fa-play"></i>
                                    </a>
                                    {% endif %}

                                    <a href="{{ url_for('proxy.restart', id=proxy.id) }}" class="btn btn-action btn-action-info" title="ریستارت">
                                        <i class="fas fa-sync-alt"></i>
                                    </a>
                                    
                                    <div class="vr bg-secondary opacity-25 mx-1"></div>
                                    
                                    <a href="{{ url_for('proxy.renew', id=proxy.id) }}" class="btn btn-action btn-action-success" title="تمدید (30 روز)">
                                        <i class="fas fa-calendar-plus"></i>
                                    </a>

                                    <a href="{{ url_for('proxy.reset_quota', id=proxy.id) }}" class="btn btn-action btn-action-warning" title="ریست حجم">
                                        <i class="fas fa-redo"></i>
                                    </a>
                                    
                                    <button class="btn btn-action btn-action-primary" onclick="handleProxyEdit(this)" data-id="{{ proxy.id }}" data-port="{{ proxy.port }}" data-tag="{{ proxy.tag or '' }}" data-quota="{{ ((proxy.quota_bytes / (1024*1024*1024))|round(2) if proxy.quota_bytes else 0) }}" data-secret="{{ proxy.display_secret }}" data-status="{{ proxy.status }}" data-username="{{ proxy.username or '' }}" data-password="{{ proxy.password or '' }}" data-ip="{{ proxy.proxy_ip or '' }}" data-name="{{ proxy.name or '' }}" title="ویرایش">
                                        <i class="fas fa-cog"></i>
                                    </button>
                                    
                                    <a href="{{ url_for('proxy.delete', id=proxy.id) }}" onclick="return confirm('آیا مطمئن هستید؟')" class="btn btn-action btn-action-danger" title="حذف">
                                        <i class="fas fa-trash-alt"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="8" class="text-center py-5 text-secondary opacity-75">
                            <div class="d-flex flex-column align-items-center">
                                <i class="fas fa-ghost fs-1 mb-3 opacity-50"></i>
                                <span>هنوز هیچ پروکسی ساخته نشده است.</span>
                            </div>
                        </td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Alerts & Logs Feed -->
    <div class="row fade-in-up delay-3 pb-5">
        <div class="col-lg-6 mb-4 mb-lg-0">
            <div class="glass-card h-100 p-0 overflow-hidden">
                <div class="card-header-clean bg-danger bg-opacity-10 border-danger border-opacity-10">
                    <div class="d-flex align-items-center gap-2">
                         <div class="p-1 rounded bg-danger bg-opacity-20 text-danger"><i class="fas fa-bell"></i></div>
                         <h6 class="mb-0 text-white fw-bold">آخرین هشدارها</h6>
                    </div>
                    <span class="badge bg-danger rounded-pill shadow-sm" id="alertsCount">0</span>
                </div>
                <div class="card-body-clean p-0">
                    <ul class="list-group list-group-flush bg-transparent" id="alertsList">
                        <li class="list-group-item text-secondary border-0 py-5 text-center bg-transparent small">
                            <i class="fas fa-check-circle fs-1 mb-3 opacity-25 text-success"></i><br>
                            هشداری ثبت نشده است.
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="glass-card h-100 p-0 overflow-hidden">
                <div class="card-header-clean">
                    <div class="d-flex align-items-center gap-2">
                        <div class="p-1 rounded bg-info bg-opacity-10 text-info"><i class="fas fa-history"></i></div>
                        <h6 class="mb-0 text-white fw-bold">لاگ سیستم</h6>
                    </div>
                    <button class="btn btn-sm btn-action btn-action-info p-0" style="width: 28px; height: 28px;" onclick="updateActivityLogs()"><i class="fas fa-sync-alt small"></i></button>
                </div>
                <div class="card-body-clean p-0">
                    <ul class="list-group list-group-flush bg-transparent" id="activityList">
                        <li class="list-group-item text-secondary border-0 py-5 text-center bg-transparent small">در حال بارگذاری...</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Proxy Modal -->
<div class="modal fade" id="addProxyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content glass-card border-0">
            <div class="modal-header border-bottom border-secondary border-opacity-10">
                <h5 class="modal-title text-white fw-bold">افزودن پروکسی جدید</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('proxy.add') }}" method="POST">
                <div class="modal-body p-4">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="text-secondary small mb-1">پورت اتصال</label>
                            <input type="number" name="port" class="form-control font-monospace" required placeholder="e.g. 443">
                        </div>
                         <div class="col-md-6">
                            <label class="text-secondary small mb-1">نوع پروتکل</label>
                            <select name="proxy_type" id="proxyType" class="form-select" onchange="toggleProxyFields()">
                                <option value="standard">Standard (MTProto)</option>
                                <option value="dd">DD (Pudding AntiF)</option>
                            </select>
                        </div>
                        <div class="col-12 d-none" id="ddDomainsField">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="text-secondary small mb-1">دامنه اول</label>
                                    <input type="text" name="dd_domain1" class="form-control font-monospace" placeholder="example.com">
                                </div>
                                <div class="col-md-6">
                                    <label class="text-secondary small mb-1">دامنه دوم</label>
                                    <input type="text" name="dd_domain2" class="form-control font-monospace" placeholder="example.net">
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <label class="text-secondary small mb-1">آی‌پی اتصال (Bind IP)</label>
                            <input type="text" name="proxy_ip" class="form-control font-monospace" placeholder="0.0.0.0 (پیش‌فرض)">
                        </div>
                        <div class="col-md-6">
                            <label class="text-secondary small mb-1">نام نمایشی (اختیاری)</label>
                            <input type="text" name="name" class="form-control" placeholder="مثال: کاربر @KillHosein">
                        </div>
                        <div class="col-md-6">
                            <label class="text-secondary small mb-1">تگ گروه‌بندی</label>
                            <input type="text" name="tag" class="form-control" placeholder="تگ تبلیغاتی از ربات گرفته شده">
                        </div>
                        <div class="col-12">
                            <label class="text-secondary small mb-1">Secret Key</label>
                            <div class="input-group">
                                <input type="text" name="secret" id="newSecret" class="form-control font-monospace text-warning bg-dark border-secondary border-opacity-25" placeholder="تولید خودکار در صورت خالی بودن">
                                <button class="btn btn-outline-secondary border-secondary border-opacity-25" type="button" onclick="generateSecret()"><i class="fas fa-dice"></i></button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="text-secondary small mb-1">تعداد Worker</label>
                            <input type="number" name="workers" class="form-control" value="1" min="1" max="4">
                        </div>
                         <div class="col-md-6">
                             <label class="text-secondary small mb-1">محدودیت حجم (GB)</label>
                             <input type="number" name="quota_gb" class="form-control" placeholder="0 = نامحدود">
                         </div>
                         <div class="col-md-6">
                             <label class="text-secondary small mb-1">اعتبار زمانی (روز)</label>
                             <input type="number" name="expiry_days" class="form-control" placeholder="0 = نامحدود">
                         </div>
                    </div>
                </div>
                <div class="modal-footer border-0 p-3 pt-0">
                    <button type="button" class="btn btn-secondary rounded-3" data-bs-dismiss="modal">لغو</button>
                    <button type="submit" class="btn btn-glow-primary px-4 rounded-3">ایجاد پروکسی</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Proxy Modal -->
<div class="modal fade" id="editProxyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content glass-card border-0">
            <div class="modal-header border-bottom border-secondary border-opacity-10">
                <h5 class="modal-title text-white fw-bold">ویرایش تنظیمات پروکسی</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="editProxyForm" method="POST">
                <div class="modal-body p-4">
                    <div class="alert alert-warning small bg-warning bg-opacity-10 text-warning border border-warning border-opacity-25 p-3 mb-4 rounded-3 d-flex align-items-center">
                        <i class="fas fa-exclamation-triangle me-3 fs-4"></i>
                        <div>تغییر پورت، سکرت یا آی‌پی باعث <strong>ریستارت آنی</strong> سرویس می‌شود و کاربران متصل قطع خواهند شد.</div>
                    </div>
                    
                    <div class="row g-4">
                        <!-- Main Settings -->
                        <div class="col-md-6">
                            <label class="small text-secondary mb-1">پورت</label>
                            <input type="number" name="port" id="editProxyPort" class="form-control font-monospace" required>
                        </div>
                        <div class="col-md-6">
                            <label class="small text-secondary mb-1">آی‌پی اتصال</label>
                            <input type="text" name="proxy_ip" id="editProxyIP" class="form-control font-monospace">
                        </div>
                        
                        <div class="col-12">
                            <label class="small text-secondary mb-1">Secret Key</label>
                            <div class="input-group">
                                <input type="text" name="secret" id="editProxySecret" class="form-control font-monospace text-warning">
                                <button class="btn btn-outline-secondary border-secondary border-opacity-25" type="button" onclick="setRandomSecretForEdit()"><i class="fas fa-sync"></i></button>
                            </div>
                        </div>

                        <div class="col-12 d-none" id="editTlsDomainField">
                            <label class="small text-secondary mb-1">دامنه Fake TLS</label>
                            <input type="text" name="tls_domain" id="editProxyTlsDomain" class="form-control font-monospace" value="">
                        </div>
                        
                        <div class="col-md-6">
                            <label class="small text-secondary mb-1">نام نمایشی</label>
                            <input type="text" name="name" id="editProxyName" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="small text-secondary mb-1">تگ</label>
                            <input type="text" name="tag" id="editProxyTag" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="small text-secondary mb-1">وضعیت سرویس</label>
                            <select name="status" id="editProxyStatus" class="form-select">
                                <option value="running">فعال (Running)</option>
                                <option value="stopped">متوقف (Stopped)</option>
                            </select>
                        </div>
                        
                        <!-- Advanced/Limits -->
                        <div class="col-12"><hr class="border-secondary border-opacity-10 my-1"></div>
                        
                        <div class="col-md-6">
                            <label class="small text-secondary mb-1">محدودیت حجم (GB)</label>
                            <input type="number" name="quota_gb" id="editProxyQuota" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="small text-secondary mb-1">تمدید اعتبار (روز)</label>
                            <input type="number" name="expiry_days" id="editProxyExpiry" class="form-control">
                        </div>

                        <!-- SOCKS5 -->
                        <div class="col-12">
                            <div class="bg-dark bg-opacity-50 p-3 rounded-3 border border-secondary border-opacity-10">
                                <h6 class="text-white small mb-3">تنظیمات SOCKS5 (اختیاری)</h6>
                                <div class="row g-3">
                                    <div class="col-md-6"><label class="small text-secondary mb-1">نام کاربری</label><input type="text" name="username" id="editProxyUser" class="form-control"></div>
                                    <div class="col-md-6"><label class="small text-secondary mb-1">رمز عبور</label><input type="text" name="password" id="editProxyPass" class="form-control"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 p-3 pt-0">
                    <button type="button" class="btn btn-secondary rounded-3" data-bs-dismiss="modal">لغو</button>
                    <button type="submit" class="btn btn-glow-primary px-4 rounded-3">ذخیره تغییرات</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bulk Create Modal -->
<div class="modal fade" id="bulkCreateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content glass-card border-0">
            <div class="modal-header border-bottom border-secondary border-opacity-10">
                <h5 class="modal-title text-white fw-bold">ساخت گروهی پروکسی</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('proxy.bulk_create') }}" method="POST">
                <div class="modal-body p-4">
                    <div class="alert alert-info small bg-info bg-opacity-10 text-info border border-info border-opacity-25 rounded-3 p-3 mb-4">
                        <i class="fas fa-info-circle me-2"></i> پروکسی‌ها به صورت متوالی و با پورت‌های پشت سر هم ساخته می‌شوند.
                    </div>
                    <div class="mb-3">
                        <label class="text-secondary small mb-1">پورت شروع</label>
                        <input type="number" name="start_port" class="form-control font-monospace" required placeholder="e.g. 20000">
                    </div>
                    <div class="mb-3">
                        <label class="text-secondary small mb-1">تعداد پروکسی</label>
                        <input type="number" name="count" class="form-control" value="10" min="1" max="50">
                    </div>
                    <div class="mb-3">
                        <label class="text-secondary small mb-1">تگ مشترک</label>
                        <input type="text" name="tag" class="form-control" placeholder="مثال: Bulk-Group-1">
                    </div>
                    <div class="mb-3">
                        <label class="text-secondary small mb-1">پیشوند نام</label>
                        <input type="text" name="name_prefix" class="form-control" placeholder="مثال: User">
                    </div>
                </div>
                <div class="modal-footer border-0 p-3 pt-0">
                    <button type="submit" class="btn btn-glow-primary w-100 rounded-3">شروع عملیات ساخت</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Details Modal -->
<div class="modal fade" id="proxyDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content glass-card border-0">
            <div class="modal-header border-bottom border-secondary border-opacity-10">
                <h5 class="modal-title text-white">جزئیات پروکسی <span id="detailsPort" class="text-info font-monospace mx-2 bg-dark px-2 rounded"></span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row g-4">
                    <div class="col-lg-4">
                        <div class="glass-card bg-transparent h-100 border border-secondary border-opacity-25">
                            <div class="card-header-clean py-2 border-bottom border-secondary border-opacity-25">
                                <h6 class="mb-0 text-white small fw-bold">کاربران متصل</h6>
                                <input id="connIpFilter" class="form-control form-control-sm bg-dark border-secondary border-opacity-25 text-white w-50" placeholder="جستجو IP...">
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive" style="max-height: 350px;">
                                    <table class="table table-sm table-dark mb-0 bg-transparent table-hover">
                                        <thead class="text-secondary small sticky-top bg-dark"><tr><th class="ps-3">IP</th><th>کشور</th><th>زمان</th></tr></thead>
                                        <tbody id="connectionsTable"><tr><td colspan="3" class="text-center text-secondary small py-3">در حال بارگذاری...</td></tr></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-8">
                        <div class="glass-card bg-transparent mb-4 border border-secondary border-opacity-25 p-3">
                            <h6 class="text-white small fw-bold mb-3 border-bottom border-secondary border-opacity-10 pb-2">ترافیک لحظه‌ای (Real-time)</h6>
                            <div style="height: 200px;"><canvas id="connectionsChart"></canvas></div>
                        </div>
                         <div class="glass-card bg-transparent border border-secondary border-opacity-25 p-3">
                            <div class="d-flex justify-content-between align-items-center mb-3 border-bottom border-secondary border-opacity-10 pb-2">
                                <h6 class="text-white small fw-bold mb-0">تاریخچه مصرف دیتا</h6>
                                <select id="usageGranularity" class="form-select form-select-sm bg-dark text-white border-secondary border-opacity-25 w-auto" style="font-size: 0.8rem;">
                                    <option value="daily">روزانه (30 روز)</option>
                                    <option value="hourly">ساعتی (24 ساعت)</option>
                                </select>
                            </div>
                            <div style="height: 200px;"><canvas id="usageChart"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary rounded-3 px-4" data-bs-dismiss="modal">بستن</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // --- Starfield Background (Cinematic) ---
    const canvas = document.getElementById('starfield');
    const ctx = canvas.getContext('2d');
    let width, height, stars = [];
    const resizeCanvas = () => { width = window.innerWidth; height = window.innerHeight; canvas.width = width; canvas.height = height; };
    class Star {
        constructor() { this.reset(); }
        reset() { 
            this.x = Math.random() * width; 
            this.y = Math.random() * height; 
            this.size = Math.random() * 1.5 + 0.1; 
            this.speed = Math.random() * 0.03 + 0.005; 
            this.opacity = Math.random() * 0.5 + 0.1; 
            this.fade = Math.random() * 0.01 + 0.002;
        }
        update() { 
            this.y -= this.speed; 
            if(this.y < 0) this.reset(); 
            // Twinkle effect
            this.opacity += this.fade;
            if (this.opacity > 0.8 || this.opacity < 0.1) this.fade = -this.fade;
        }
        draw() { 
            ctx.fillStyle = `rgba(255,255,255,${this.opacity})`; 
            ctx.beginPath(); 
            ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); 
            ctx.fill(); 
        }
    }
    const initStars = () => { stars = Array.from({length: 60}, () => new Star()); }; 
    const animateStars = () => { ctx.clearRect(0,0,width,height); stars.forEach(s => { s.update(); s.draw(); }); requestAnimationFrame(animateStars); };
    window.addEventListener('resize', () => { resizeCanvas(); initStars(); });
    resizeCanvas(); initStars(); animateStars();

    // --- Helper Functions ---
    const formatBytes = (bytes, decimals = 2) => {
        if (!+bytes) return '0 Bytes';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
    };
    const formatMB = (mb) => formatBytes(mb * 1024 * 1024);

    const copyToClipboard = (text) => { 
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(text).then(() => {
                Swal.fire({
                    toast:true, position:'bottom-end', icon:'success', title:'کپی شد', 
                    showConfirmButton:false, timer:2000, 
                    background:'#1e293b', color:'#f8fafc',
                    customClass: { popup: 'rounded-4 border border-secondary border-opacity-10' }
                });
            });
        } else {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed"; textArea.style.left = "-9999px";
            document.body.appendChild(textArea); textArea.focus(); textArea.select();
            try {
                document.execCommand('copy');
                Swal.fire({
                    toast:true, position:'bottom-end', icon:'success', title:'کپی شد', 
                    showConfirmButton:false, timer:2000, 
                    background:'#1e293b', color:'#f8fafc',
                    customClass: { popup: 'rounded-4 border border-secondary border-opacity-10' }
                });
            } catch (err) { console.error(err); }
            document.body.removeChild(textArea);
        }
    };
    
    const utf8ToHex = (str) => {
        try {
            const bytes = new TextEncoder().encode(str);
            return Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join('');
        } catch (_) {
            return '';
        }
    };

    const generateSecret = () => {
        const type = document.getElementById('proxyType').value;
        let sec = [...Array(32)].map(()=>Math.floor(Math.random()*16).toString(16)).join('');
        document.getElementById('newSecret').value = type==='dd' ? 'dd'+sec : sec;
    };
    const generateRandomHex = () => [...Array(32)].map(()=>Math.floor(Math.random()*16).toString(16)).join('');
    
    const setRandomSecretForEdit = () => {
        const secret = generateRandomHex();
        const el = document.getElementById('editProxySecret');
        if(!el) return;
        const current = (el.value || '').trim().toLowerCase();
        if (current.startsWith('ee')) {
            const domain = (document.getElementById('editProxyTlsDomain')?.value || '').trim().toLowerCase();
            const domainHex = utf8ToHex(domain);
            const existingPayload = current.slice(2);
            const existingDomainHex = existingPayload.length > 32 ? existingPayload.slice(32) : '';
            el.value = 'ee' + secret + (domainHex || existingDomainHex);
            return;
        }
        if (current.startsWith('dd')) {
            el.value = 'dd' + secret;
            return;
        }
        el.value = secret;
    };

    const copyProxyLink = (port, secret, proxyIp) => {
        const serverIp = proxyIp || '{{ server_ip }}' || window.location.hostname;
        const link = `tg://proxy?server=${serverIp}&port=${port}&secret=${secret}`;
        copyToClipboard(link);
    };
    
    const toggleProxyFields = () => {
        const type = document.getElementById('proxyType').value;
        const ddFields = document.getElementById('ddDomainsField');
        if (ddFields) {
            if (type === 'dd') {
                ddFields.classList.remove('d-none');
            } else {
                ddFields.classList.add('d-none');
            }
        }
    };
    
    function showLink(port, secret, proxyIp) {
        const serverIp = proxyIp || '{{ server_ip }}' || window.location.hostname;
        const link = `tg://proxy?server=${serverIp}&port=${port}&secret=${secret}`;
        Swal.fire({
            html: `<div class="mb-4 text-start"><label class="small text-secondary mb-2 fw-bold">لینک اتصال</label><input class="form-control bg-dark text-info text-center font-monospace border-secondary border-opacity-25 py-3" value="${link}" readonly onclick="this.select()"></div><a href="${link}" class="btn btn-glow-primary w-100 py-3 rounded-3 fw-bold"><i class="fab fa-telegram-plane me-2 fs-5"></i>اتصال به تلگرام</a>`,
            background: '#0f172a', showConfirmButton: false, showCloseButton: true,
            customClass: { popup: 'border border-secondary border-opacity-25 rounded-5 p-4' }
        });
    }
    
    function formatUptime(seconds) {
        const d = Math.floor(seconds / (3600*24));
        const h = Math.floor(seconds % (3600*24) / 3600);
        const m = Math.floor(seconds % 3600 / 60);
        return d > 0 ? `${d} روز, ${h} ساعت` : `${h} ساعت, ${m} دقیقه`;
    }

    // --- Chart Setup with Gradients ---
    Chart.defaults.font.family = 'Vazirmatn'; 
    Chart.defaults.color = '#64748b'; 
    Chart.defaults.borderColor = 'rgba(255,255,255,0.03)';
    
    const createGradient = (ctx, colorStart, colorEnd) => {
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, colorStart);
        gradient.addColorStop(1, colorEnd);
        return gradient;
    };

    // Main System Chart
    const sysCtx = document.getElementById('systemChart').getContext('2d');
    const sysChart = new Chart(sysCtx, {
        type: 'line',
        data: { 
            labels: Array(20).fill(''), 
            datasets: [
                { 
                    label:'CPU Usage', 
                    data:Array(20).fill(0), 
                    borderColor:'#8b5cf6', 
                    backgroundColor: createGradient(sysCtx, 'rgba(139, 92, 246, 0.5)', 'rgba(139, 92, 246, 0.0)'),
                    fill:true, tension:0.4, pointRadius:0, borderWidth: 3,
                    pointHoverRadius: 6, pointHoverBackgroundColor: '#fff', pointHoverBorderWidth: 3
                }, 
                { 
                    label:'RAM Usage', 
                    data:Array(20).fill(0), 
                    borderColor:'#10b981', 
                    backgroundColor: createGradient(sysCtx, 'rgba(16, 185, 129, 0.3)', 'rgba(16, 185, 129, 0.0)'),
                    fill:true, tension:0.4, pointRadius:0, borderWidth: 3,
                    pointHoverRadius: 6, pointHoverBackgroundColor: '#fff', pointHoverBorderWidth: 3
                }
            ] 
        },
        options: { 
            responsive:true, maintainAspectRatio:false, 
            interaction: { mode: 'index', intersect: false },
            plugins:{
                legend:{display:false},
                tooltip: {
                    backgroundColor: 'rgba(15, 23, 42, 0.9)',
                    titleColor: '#f8fafc',
                    bodyColor: '#cbd5e1',
                    borderColor: 'rgba(255,255,255,0.1)',
                    borderWidth: 1,
                    padding: 12,
                    displayColors: true,
                    usePointStyle: true,
                    titleFont: { family: 'Vazirmatn' },
                    bodyFont: { family: 'Vazirmatn' }
                }
            }, 
            scales:{
                x:{display:false}, 
                y:{
                    beginAtZero:true, max:100, 
                    grid:{color:'rgba(255,255,255,0.03)', drawBorder: false},
                    ticks: { color: '#64748b', font: {size: 10} }
                }
            } 
        }
    });

    // Traffic Chart
    const trafCtx = document.getElementById('trafficChart').getContext('2d');
    const trafChart = new Chart(trafCtx, {
        type: 'bar', 
        data: { labels:[], datasets:[{ label:'دانلود (MB)', data:[], backgroundColor:'#06b6d4', borderRadius:6, hoverBackgroundColor:'#22d3ee' }] },
        options: { 
            responsive:true, maintainAspectRatio:false, 
            plugins:{legend:{display:false}, tooltip:{backgroundColor:'rgba(15,23,42,0.9)', padding:10, cornerRadius:8}}, 
            scales:{
                x:{grid:{display:false}, ticks: { color: '#64748b', font: {size: 10} }}, 
                y:{grid:{color:'rgba(255,255,255,0.02)', drawBorder: false}, ticks: { color: '#64748b', font: {size: 10} }}
            } 
        }
    });

    // Sparklines Setup
    const sparkOptions = { 
        responsive:true, maintainAspectRatio:false, 
        plugins:{legend:{display:false}, tooltip:{enabled:false}}, 
        scales:{x:{display:false}, y:{display:false, min:0}},
        elements: { point: { radius: 0 } }
    };
    const createSparkline = (id, color, bg) => new Chart(document.getElementById(id), {
        type: 'line',
        data: { 
            labels: Array(10).fill(''), 
            datasets: [{ 
                data: Array(10).fill(0), 
                borderColor: color, 
                backgroundColor: bg || 'transparent', 
                borderWidth: 2, 
                tension: 0.5, 
                fill: !!bg 
            }] 
        },
        options: sparkOptions
    });
    
    const sparkCpu = createSparkline('sparkCpu', '#8b5cf6', 'rgba(139, 92, 246, 0.1)');
    const sparkRam = createSparkline('sparkRam', '#10b981', 'rgba(16, 185, 129, 0.1)');
    const sparkNet = createSparkline('sparkNet', '#06b6d4', 'rgba(6, 182, 212, 0.1)');
    
    // --- Data Update Logic ---
    let currentProxyId, connChart, usageChart, lastAlertId = 0, lastNetSent=null, lastNetRecv=null, lastTime=Date.now();
    
    const updateLatency = () => fetch('/api/latency').then(r=>r.json()).then(d => {
        const el = document.getElementById('latency-display');
        if(d.status === 'success') {
            el.innerText = d.latency + 'ms';
            el.className = `fw-bold font-monospace ${d.latency < 100 ? 'text-success' : (d.latency < 300 ? 'text-warning' : 'text-danger')}`;
        } else {
            el.innerText = 'Err';
            el.className = 'fw-bold text-danger font-monospace';
        }
    });

    let countryChartInstance = null;
    const updateCountryChart = () => fetch('/api/reports/top_ips').then(r=>r.json()).then(data => {
        document.getElementById('countryChartLoading').style.display = 'none';
        const ctx = document.getElementById('countryChart').getContext('2d');
        
        // Aggregate by country
        const countries = {};
        data.forEach(d => { countries[d.country] = (countries[d.country] || 0) + d.connections; });
        const labels = Object.keys(countries);
        const values = Object.values(countries);
        
        if(countryChartInstance) countryChartInstance.destroy();
        
        countryChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4'],
                    borderWidth: 0,
                    hoverOffset: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { color: '#94a3b8', font: {family: 'Vazirmatn'}, boxWidth: 10, usePointStyle: true } }
                },
                cutout: '75%',
                layout: { padding: 10 }
            }
        });
    });

    const updateStats = () => fetch('/api/stats').then(r=>r.json()).then(d => {
        document.getElementById('cpu-usage').innerText = d.cpu; 
        document.getElementById('ram-usage').innerText = d.mem_percent;
        document.getElementById('ram-used').innerText = d.mem_used; 
        document.getElementById('ram-total').innerText = d.mem_total;
        
        if(d.uptime) document.getElementById('uptime-display').innerText = formatUptime(d.uptime);
        if(d.load_avg) document.getElementById('load-avg-display').innerText = d.load_avg[0];
        
        // Net Speed
        const now = Date.now(); const tDiff = (now - lastTime)/1000;
        let speedBytes = 0;
        if(lastNetRecv!==null && tDiff>0) {
            speedBytes = ((d.net_recv - lastNetRecv) * 1024 * 1024) / tDiff;
            // Just the number for the main display
            document.getElementById('net-down-speed').innerText = formatBytes(speedBytes); 
        }
        lastNetRecv = d.net_recv; lastTime = now;
        document.getElementById('net-total-down').innerText = formatMB(d.net_recv);

        // Update Charts & Sparklines
        document.getElementById('cpu-bar').style.width = d.cpu+'%';
        
        const updateChartData = (chart, val) => {
            chart.data.datasets[0].data.push(val);
            chart.data.datasets[0].data.shift();
            chart.update('none'); // 'none' for performance
        };

        updateChartData(sysChart, d.cpu);
        sysChart.data.datasets[1].data.push(d.mem_percent);
        sysChart.data.datasets[1].data.shift();
        sysChart.update('none');

        updateChartData(sparkCpu, d.cpu);
        updateChartData(sparkRam, d.mem_percent);
        // Normalize net speed for sparkline (roughly, to show activity)
        updateChartData(sparkNet, speedBytes > 0 ? Math.log(speedBytes+1) : 0); 
    });
    
    const updateProxies = () => fetch('/api/proxies').then(r=>r.json()).then(d => {
        d.forEach(p => {
            const els = { 
                u:document.getElementById(`proxy-users-${p.id}`), 
                r:document.getElementById(`proxy-download-rate-${p.id}`), 
                qU:document.getElementById(`proxy-quota-used-${p.id}`), 
                qT:document.getElementById(`proxy-quota-total-${p.id}`), 
                qB:document.getElementById(`proxy-quota-bar-${p.id}`) 
            };
            
            if(els.u) els.u.innerText = p.active_connections;
            if(els.r) els.r.innerText = p.download_rate_mbps||0;
            
            if(els.qU) {
                const used = (p.quota_used_mb/1024).toFixed(2);
                els.qU.innerText = used;
                
                if (p.quota_mb) {
                    const total = (p.quota_mb/1024).toFixed(2);
                    els.qT.innerText = total;
                    const pct = Math.min(100, (p.quota_used_mb/p.quota_mb)*100);
                    els.qB.style.width = pct+'%';
                    
                    if (pct > 90) {
                        els.qB.className = 'progress-bar rounded-pill bg-danger';
                        els.qB.style.background = '';
                        els.qB.style.boxShadow = '0 0 10px rgba(239, 68, 68, 0.5)';
                    } else {
                        els.qB.className = 'progress-bar rounded-pill';
                        els.qB.style.background = 'linear-gradient(to right, #4ade80, #10b981)';
                        els.qB.style.boxShadow = '0 0 10px rgba(16, 185, 129, 0.3)';
                    }
                } else {
                    els.qT.innerText = '∞';
                    els.qB.style.width = '100%';
                    els.qB.className = 'progress-bar rounded-pill bg-info bg-opacity-50';
                }
            }
        });
        applyProxyFilters();
    });

    const updateTrafficHistory = () => fetch('/api/history').then(r=>r.json()).then(d => {
        trafChart.data.labels = d.labels; trafChart.data.datasets[0].data = d.download; trafChart.update();
    });

    // Filters
    const applyProxyFilters = () => {
        const search = (document.getElementById('proxySearch')?.value||'').toLowerCase();
        const status = (document.getElementById('proxyStatusFilter')?.value||'').toLowerCase();
        document.querySelectorAll('#proxiesTable tbody tr').forEach(tr => {
            const port = (tr.querySelector('[data-proxy-port]')?.getAttribute('data-proxy-port')||'').toLowerCase();
            const tag = (tr.querySelector('[data-proxy-tag]')?.getAttribute('data-proxy-tag')||'').toLowerCase();
            const st = (tr.querySelector('[data-proxy-status]')?.getAttribute('data-proxy-status')||'').toLowerCase();
            tr.style.display = ((port.includes(search)||tag.includes(search)) && (!status || st===status)) ? '' : 'none';
        });
    };

    // Alerts & Logs
    const updateAlerts = () => fetch(`/api/alerts?since_id=${lastAlertId}`).then(r=>r.json()).then(items => {
        if(!items || !items.length) return;
        const list = document.getElementById('alertsList');
        items.forEach(a => {
            lastAlertId = Math.max(lastAlertId, a.id);
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center bg-transparent border-bottom border-secondary border-opacity-10 text-white small py-3 fade-in-up';
            li.innerHTML = `
                <div class="d-flex align-items-center gap-3">
                    <i class="fas fa-exclamation-triangle text-warning"></i>
                    <span class="text-truncate" style="max-width: 200px;">${a.message}</span>
                </div>
                <span class="badge bg-danger rounded-pill">${a.severity}</span>
            `;
            if(list.firstElementChild?.classList.contains('text-center')) list.innerHTML = '';
            list.prepend(li);
            // Limit list size
            if(list.children.length > 5) list.lastElementChild.remove();
            
            Swal.fire({
                toast:true, position:'bottom-start', icon:'warning', 
                title: a.message, showConfirmButton:false, timer:5000, 
                background:'#1e293b', color:'#fff',
                customClass: { popup: 'border border-warning border-opacity-25 rounded-4' }
            });
        });
        document.getElementById('alertsCount').innerText = document.querySelectorAll('#alertsList li:not(.text-center)').length;
    });

    const updateActivityLogs = () => fetch('/api/activity?limit=8').then(r=>r.json()).then(items => {
        const list = document.getElementById('activityList');
        if(!list) return;
        if(!items.length) { list.innerHTML = `<li class="list-group-item text-secondary border-0 text-center py-5 bg-transparent small">موردی یافت نشد.</li>`; return; }
        list.innerHTML = items.map(it => `
            <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent border-bottom border-secondary border-opacity-10 py-3">
                <div class="d-flex align-items-center overflow-hidden">
                    <div class="rounded-circle bg-dark border border-secondary border-opacity-25 p-2 me-3 text-secondary d-flex align-items-center justify-content-center" style="width: 36px; height: 36px; flex-shrink: 0;">
                        <i class="fas fa-terminal small text-info"></i>
                    </div>
                    <div class="text-truncate">
                        <div class="text-white small fw-bold text-truncate">${it.action}</div>
                        <div class="text-secondary small text-truncate opacity-75" style="font-size: 0.75rem;">${it.details || ''}</div>
                    </div>
                </div>
                <span class="text-secondary small font-monospace ms-2" style="font-size: 0.7rem;">${new Date(it.timestamp).toLocaleTimeString('fa-IR', {hour:'2-digit', minute:'2-digit'})}</span>
            </li>
        `).join('');
    });

    // Modal Helpers
    const handleProxyEdit = (btn) => {
        const d = btn.dataset;
        openProxyEdit(d.id, d.port, d.tag, d.quota, d.secret, d.status, d.username, d.password, d.ip, d.name);
    };

    const openProxyEdit = (id, port, tag, quota, secret, status, user, pass, ip, name) => {
        const form = document.getElementById('editProxyForm'); form.action = `/proxy/update/${id}`;
        document.getElementById('editProxyPort').value = port;
        document.getElementById('editProxyName').value = name||'';
        document.getElementById('editProxySecret').value = secret;
        document.getElementById('editProxyQuota').value = quota||'';
        document.getElementById('editProxyStatus').value = status;
        document.getElementById('editProxyTag').value = tag||'';
        document.getElementById('editProxyUser').value = user||'';
        document.getElementById('editProxyPass').value = pass||'';
        document.getElementById('editProxyIP').value = ip||'';
        const tlsField = document.getElementById('editTlsDomainField');
        const tlsInput = document.getElementById('editProxyTlsDomain');
        const s = (secret || '').trim().toLowerCase();
        if (s.startsWith('ee')) {
            const payload = s.slice(2);
            const domainHex = payload.length > 32 ? payload.slice(32) : '';
            let decoded = '';
            if (domainHex && domainHex.length % 2 === 0) {
                try {
                    const bytes = new Uint8Array(domainHex.match(/.{1,2}/g).map(b => parseInt(b, 16)));
                    decoded = new TextDecoder().decode(bytes);
                } catch (_) {}
            }
            if (tlsInput) tlsInput.value = decoded || 'google.com';
            if (tlsField) tlsField.classList.remove('d-none');
        } else {
            if (tlsInput) tlsInput.value = '';
            if (tlsField) tlsField.classList.add('d-none');
        }
        new bootstrap.Modal(document.getElementById('editProxyModal')).show();
    };

    const openProxyDetails = (id, port) => {
        currentProxyId = id; 
        document.getElementById('detailsPort').innerText = port;
        new bootstrap.Modal(document.getElementById('proxyDetailsModal')).show();
        
        // Reset charts data
        if(connChart) { connChart.data.labels=[]; connChart.data.datasets[0].data=[]; connChart.update(); }
        
        updateConnections(id);
        updateUsageHistory(id);
        
        // Ensure charts exist
        if(!connChart) connChart = new Chart(document.getElementById('connectionsChart'), { 
            type:'line', 
            data:{labels:[], datasets:[{data:[], borderColor:'#ef4444', backgroundColor:'rgba(239,68,68,0.1)', fill:true, tension:0.4, pointRadius:0, borderWidth:2}]}, 
            options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{grid:{color:'rgba(255,255,255,0.03)'}}}} 
        });
        if(!usageChart) usageChart = new Chart(document.getElementById('usageChart'), { 
            type:'bar', 
            data:{labels:[], datasets:[{data:[], backgroundColor:'#10b981', borderRadius:3}]}, 
            options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{grid:{display:false}}, y:{grid:{color:'rgba(255,255,255,0.03)'}}}} 
        });
    };

    const updateConnections = (id) => {
        const f = document.getElementById('connIpFilter')?.value || '';
        fetch(`/api/proxy/${id}/connections${f ? '?ip='+encodeURIComponent(f) : ''}`).then(r=>r.json()).then(d => {
            const tbody = document.getElementById('connectionsTable');
            tbody.innerHTML = d.items?.length ? d.items.map(i=>`<tr><td class="font-monospace text-info ps-3">${i.ip}</td><td class="text-white small">${i.country||'-'}</td><td class="font-monospace small text-secondary">${i.connected_for||'-'}</td></tr>`).join('') : '<tr><td colspan="3" class="text-center text-muted small py-4">هیچ کاربری متصل نیست</td></tr>';
        });
        fetch(`/api/proxy/${id}/connections_history?minutes=60`).then(r=>r.json()).then(d => { if(connChart) { connChart.data.labels = d.labels; connChart.data.datasets[0].data = d.values; connChart.update(); }});
    };

    const updateUsageHistory = (id) => {
        const g = document.getElementById('usageGranularity')?.value || 'daily';
        fetch(`/api/proxy/${id}/usage_history?granularity=${g}&days=30`).then(r=>r.json()).then(d => { if(usageChart) { usageChart.data.labels = d.labels; usageChart.data.datasets[0].data = d.download_mb; usageChart.update(); }});
    };

    // Event Listeners & Timers
    document.getElementById('proxySearch')?.addEventListener('input', applyProxyFilters);
    document.getElementById('proxyStatusFilter')?.addEventListener('change', applyProxyFilters);
    document.getElementById('connIpFilter')?.addEventListener('input', () => { if(currentProxyId) updateConnections(currentProxyId); });
    document.getElementById('usageGranularity')?.addEventListener('change', () => { if(currentProxyId) updateUsageHistory(currentProxyId); });

    setInterval(updateStats, 2000); 
    setInterval(updateProxies, 5000);
    setInterval(updateLatency, 10000);
    setInterval(updateAlerts, 6000); // Slightly slower
    setInterval(updateTrafficHistory, 60000);
    setInterval(() => { if(currentProxyId && document.getElementById('proxyDetailsModal').classList.contains('show')) updateConnections(currentProxyId); }, 5000);

    // Initial Load
    updateStats(); updateProxies(); updateLatency(); updateTrafficHistory(); updateAlerts(); updateActivityLogs();

    // Initialize Progress Bars
    document.querySelectorAll('.init-width').forEach(el => {
        setTimeout(() => { el.style.width = el.dataset.width; }, 100);
    });

    // Quick Actions
    function restartService() {
        Swal.fire({
            title: 'آیا مطمئن هستید؟',
            text: "سرویس پنل و پروکسی‌ها ریستارت خواهند شد.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'بله، ریستارت شود',
            cancelButtonText: 'لغو',
            background: '#1e293b', color: '#fff'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch('/system/restart_service', {method: 'POST'})
                    .then(r => r.json())
                    .then(d => {
                        if(d.status === 'success') Swal.fire({icon:'success', title:'دستور ارسال شد', text:'سرویس در حال ریستارت است...', background:'#1e293b', color:'#fff'});
                        else Swal.fire({icon:'error', title:'خطا', text:d.message, background:'#1e293b', color:'#fff'});
                    });
            }
        });
    }

    function backupSystem() {
        Swal.fire({title:'در حال تهیه پشتیبان...', didOpen:()=>{Swal.showLoading()}, background:'#1e293b', color:'#fff', showConfirmButton:false});
        fetch('/system/backup', {method: 'POST'})
            .then(r => r.json())
            .then(d => {
                if(d.status === 'success') {
                    Swal.fire({
                        icon:'success', title:'موفق', text:d.message, 
                        showCancelButton:true, confirmButtonText:'دانلود فایل', cancelButtonText:'بستن',
                        background:'#1e293b', color:'#fff'
                    }).then((r) => {
                        if(r.isConfirmed) window.location.href = `/system/download_backup/${d.filename}`;
                    });
                } else {
                    Swal.fire({icon:'error', title:'خطا', text:d.message, background:'#1e293b', color:'#fff'});
                }
            })
            .catch(err => Swal.fire({icon:'error', title:'خطا', text:'خطا در ارتباط با سرور', background:'#1e293b', color:'#fff'}));
    }
</script>
{% endblock %}
