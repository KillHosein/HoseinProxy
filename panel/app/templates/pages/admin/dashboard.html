{% extends "layouts/base.html" %}

{% block title %}داشبورد مدیریت | HoseinProxy{% endblock %}

{% block content %}
<!-- فونت وزیرمتن (نسخه رسمی و کامل) -->
<link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />

<style>
    :root {
        /* پالت رنگی مدرن و حرفه‌ای */
        --bg-body: #0f172a;       /* Slate 900 */
        --bg-card: rgba(30, 41, 59, 0.7); /* Slate 800 - Transparent */
        --bg-hover: rgba(51, 65, 85, 0.5); /* Slate 700 - Transparent */
        
        --border-color: rgba(255, 255, 255, 0.08);
        --border-hover: rgba(255, 255, 255, 0.15);
        
        --text-primary: #f1f5f9;  /* Slate 100 */
        --text-secondary: #94a3b8; /* Slate 400 */
        --text-muted: #64748b;    /* Slate 500 */
        
        --accent-primary: #6366f1; /* Indigo 500 */
        --accent-hover: #4f46e5;   /* Indigo 600 */
        --accent-glow: rgba(99, 102, 241, 0.25);
        
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --info: #06b6d4;

        --glass-blur: blur(16px);
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    body {
        font-family: 'Vazirmatn', system-ui, -apple-system, sans-serif !important;
        background-color: var(--bg-body) !important;
        background-image: 
            radial-gradient(circle at 15% 50%, rgba(99, 102, 241, 0.08), transparent 25%), 
            radial-gradient(circle at 85% 30%, rgba(16, 185, 129, 0.05), transparent 25%);
        color: var(--text-primary) !important;
        overflow-x: hidden;
        min-height: 100vh;
    }

    /* کامپوننت کارت شیشه‌ای حرفه‌ای */
    .glass-panel {
        background: var(--bg-card);
        backdrop-filter: var(--glass-blur);
        -webkit-backdrop-filter: var(--glass-blur);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        transition: var(--transition);
        overflow: hidden;
        position: relative;
    }

    .glass-panel:hover {
        border-color: var(--border-hover);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    /* هدر کارت‌ها */
    .panel-header {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: rgba(255, 255, 255, 0.02);
    }
    
    .panel-title {
        font-weight: 700;
        font-size: 1rem;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin: 0;
    }

    .panel-body { padding: 1.5rem; }

    /* دکمه‌های مدرن */
    .btn-modern {
        border-radius: 10px;
        font-weight: 500;
        padding: 0.5rem 1rem;
        transition: var(--transition);
        border: 1px solid transparent;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        font-size: 0.9rem;
        cursor: pointer;
    }
    
    .btn-primary-glow {
        background: var(--accent-primary);
        color: white;
        box-shadow: 0 0 0 1px var(--accent-primary), 0 4px 12px var(--accent-glow);
    }
    .btn-primary-glow:hover {
        background: var(--accent-hover);
        box-shadow: 0 0 0 1px var(--accent-hover), 0 6px 16px var(--accent-glow);
        transform: translateY(-1px);
    }

    .btn-outline-glass {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
    }
    .btn-outline-glass:hover {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-primary);
        border-color: var(--border-hover);
    }

    .btn-icon-sm {
        width: 32px;
        height: 32px;
        padding: 0;
        border-radius: 8px;
    }

    /* جدول مدرن */
    .modern-table-wrapper {
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid var(--border-color);
    }
    
    .table-modern {
        width: 100%;
        border-collapse: collapse;
        margin: 0;
    }
    
    .table-modern thead {
        background: rgba(15, 23, 42, 0.5);
    }
    
    .table-modern th {
        text-align: right;
        padding: 1rem 1.5rem;
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .table-modern td {
        padding: 1rem 1.5rem;
        border-top: 1px solid var(--border-color);
        color: var(--text-primary);
        vertical-align: middle;
        transition: background-color 0.2s;
    }
    
    .table-modern tbody tr:hover td {
        background-color: var(--bg-hover);
    }

    /* استایل وضعیت و بج‌ها */
    .badge-status {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        gap: 0.35rem;
    }
    .badge-status::before { content: ''; width: 6px; height: 6px; border-radius: 50%; }
    
    .status-running { background: rgba(16, 185, 129, 0.1); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.2); }
    .status-running::before { background: #34d399; box-shadow: 0 0 6px #34d399; }
    
    .status-stopped { background: rgba(239, 68, 68, 0.1); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.2); }
    .status-stopped::before { background: #f87171; }

    /* فرم‌ها */
    .form-modern {
        background-color: rgba(15, 23, 42, 0.4) !important;
        border: 1px solid var(--border-color) !important;
        color: var(--text-primary) !important;
        border-radius: 10px;
        padding: 0.65rem 1rem;
        font-size: 0.95rem;
        transition: var(--transition);
    }
    .form-modern:focus {
        border-color: var(--accent-primary) !important;
        box-shadow: 0 0 0 3px var(--accent-glow) !important;
        background-color: rgba(15, 23, 42, 0.8) !important;
    }
    
    /* انیمیشن‌ها */
    .fade-in { animation: fadeIn 0.5s ease-out forwards; opacity: 0; transform: translateY(10px); }
    @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
    .delay-100 { animation-delay: 100ms; }
    .delay-200 { animation-delay: 200ms; }
    .delay-300 { animation-delay: 300ms; }

    /* موبایل */
    @media (max-width: 991px) {
        .table-modern, .table-modern thead, .table-modern tbody, .table-modern th, .table-modern td, .table-modern tr { display: block; }
        .table-modern thead { display: none; }
        .table-modern tbody tr {
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            background: var(--bg-card);
            overflow: hidden;
        }
        .table-modern td {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.85rem 1.25rem;
            border-top: 1px solid var(--border-color);
            text-align: left;
        }
        .table-modern td:first-child { border-top: none; background: rgba(255,255,255,0.02); }
        .table-modern td::before {
            content: attr(data-label);
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
    }
    
    /* پروگرس بار */
    .progress-track { background: rgba(255,255,255,0.05); height: 6px; border-radius: 99px; overflow: hidden; }
    .progress-fill { height: 100%; border-radius: 99px; transition: width 0.5s ease; }
    .progress-primary { background: var(--accent-primary); }
    .progress-success { background: var(--success); }
    .progress-warning { background: var(--warning); }
</style>

<div class="container-fluid py-4 px-lg-5">
    
    <!-- هدر اصلی -->
    <div class="d-flex flex-wrap justify-content-between align-items-end mb-5 fade-in">
        <div>
            <h1 class="h3 fw-bold text-white mb-2">داشبورد مدیریتی</h1>
            <p class="text-secondary mb-0">نمای کلی وضعیت سرور و پروکسی‌ها</p>
        </div>
        
        <div class="d-flex gap-3 align-items-center mt-3 mt-md-0">
            <div class="glass-panel px-4 py-2 d-flex align-items-center gap-4">
                <div class="d-flex align-items-center">
                    <div class="text-end me-3">
                        <div class="text-secondary small" style="font-size: 0.7rem; letter-spacing: 0.5px;">UPTIME</div>
                        <div id="uptime-display" class="fw-bold text-white font-monospace small">loading...</div>
                    </div>
                    <i class="fas fa-clock text-info opacity-75 fs-5"></i>
                </div>
                <div class="vr bg-secondary opacity-25"></div>
                <div class="d-flex align-items-center">
                    <div class="text-end me-3">
                        <div class="text-secondary small" style="font-size: 0.7rem; letter-spacing: 0.5px;">LOAD AVG</div>
                        <div id="load-avg-display" class="fw-bold text-white font-monospace small">-</div>
                    </div>
                    <i class="fas fa-server text-warning opacity-75 fs-5"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- کارت‌های وضعیت (Stats Cards) -->
    <div class="row g-4 mb-5">
        <!-- CPU Card -->
        <div class="col-xl-3 col-md-6 fade-in delay-100">
            <div class="glass-panel h-100 p-4 position-relative">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <span class="text-secondary small fw-bold text-uppercase ls-1">CPU Usage</span>
                        <h2 class="mt-2 mb-0 text-white fw-bold display-6"><span id="cpu-usage">--</span><span class="fs-5 text-secondary ms-1">%</span></h2>
                    </div>
                    <div class="bg-primary bg-opacity-10 p-3 rounded-circle text-primary">
                        <i class="fas fa-microchip fs-4"></i>
                    </div>
                </div>
                <div class="progress-track mt-2">
                    <div id="cpu-bar" class="progress-fill progress-primary" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- RAM Card -->
        <div class="col-xl-3 col-md-6 fade-in delay-100">
            <div class="glass-panel h-100 p-4">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <span class="text-secondary small fw-bold text-uppercase ls-1">RAM Usage</span>
                        <h2 class="mt-2 mb-0 text-white fw-bold display-6"><span id="ram-usage">--</span><span class="fs-5 text-secondary ms-1">%</span></h2>
                    </div>
                    <div class="bg-success bg-opacity-10 p-3 rounded-circle text-success">
                        <i class="fas fa-memory fs-4"></i>
                    </div>
                </div>
                <div class="progress-track mt-2">
                    <div id="ram-bar" class="progress-fill progress-success" style="width: 0%"></div>
                </div>
                <div class="text-secondary small mt-2 text-end font-monospace"><span id="ram-used">--</span> / <span id="ram-total">--</span> GB</div>
            </div>
        </div>

        <!-- Network Card -->
        <div class="col-xl-3 col-md-6 fade-in delay-200">
            <div class="glass-panel h-100 p-4">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <span class="text-secondary small fw-bold text-uppercase ls-1">Network</span>
                        <h2 class="mt-2 mb-0 text-white fw-bold display-6 font-monospace"><span id="net-down-speed">0</span> <span class="fs-6 text-secondary">MB/s</span></h2>
                    </div>
                    <div class="bg-info bg-opacity-10 p-3 rounded-circle text-info">
                        <i class="fas fa-network-wired fs-4"></i>
                    </div>
                </div>
                <div class="d-flex justify-content-between align-items-center mt-3 pt-2 border-top border-white border-opacity-10">
                    <span class="text-secondary small">Total Traffic</span>
                    <span id="net-total-down" class="text-white fw-bold font-monospace small">--</span>
                </div>
            </div>
        </div>

        <!-- Proxies Status Card -->
        <div class="col-xl-3 col-md-6 fade-in delay-200">
            <div class="glass-panel h-100 p-4">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <span class="text-secondary small fw-bold text-uppercase ls-1">Active Proxies</span>
                        <h2 class="mt-2 mb-0 text-white fw-bold display-6">
                            {{ proxies|selectattr('status', 'equalto', 'running')|list|length }}
                            <span class="fs-4 text-muted fw-light">/ {{ proxies|length }}</span>
                        </h2>
                    </div>
                    <div class="bg-warning bg-opacity-10 p-3 rounded-circle text-warning">
                        <i class="fas fa-shield-alt fs-4"></i>
                    </div>
                </div>
                <div class="d-flex align-items-center gap-2 mt-3">
                    <span class="badge bg-success bg-opacity-20 text-success rounded-pill px-2 py-1 small">Running</span>
                    <span class="text-secondary small ms-auto">System Operational</span>
                </div>
            </div>
        </div>
    </div>

    <!-- نمودارها -->
    <div class="row g-4 mb-5 fade-in delay-300">
        <div class="col-lg-8">
            <div class="glass-panel h-100">
                <div class="panel-header">
                    <h5 class="panel-title"><i class="fas fa-chart-area text-primary"></i> منابع سیستم (Real-time)</h5>
                </div>
                <div class="panel-body">
                    <div style="height: 300px;"><canvas id="systemChart"></canvas></div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="glass-panel h-100">
                <div class="panel-header">
                    <h5 class="panel-title"><i class="fas fa-exchange-alt text-info"></i> ترافیک مصرفی</h5>
                </div>
                <div class="panel-body">
                    <div style="height: 300px;"><canvas id="trafficChart"></canvas></div>
                </div>
            </div>
        </div>
    </div>

    <!-- لیست پروکسی‌ها -->
    <div class="glass-panel mb-5 fade-in delay-300">
        <div class="panel-header flex-wrap gap-3">
            <div class="d-flex align-items-center gap-3">
                <div class="bg-primary rounded-3 p-2 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                    <i class="fas fa-list text-white"></i>
                </div>
                <div>
                    <h5 class="mb-0 text-white fw-bold">لیست پروکسی‌ها</h5>
                    <span class="text-secondary small">مدیریت و نظارت بر کانکشن‌ها</span>
                </div>
            </div>
            
            <div class="d-flex gap-2 flex-grow-1 justify-content-end flex-wrap">
                <div class="position-relative" style="min-width: 200px;">
                    <i class="fas fa-search position-absolute top-50 start-0 translate-middle-y ms-3 text-secondary"></i>
                    <input id="proxySearch" type="text" class="form-modern ps-5 w-100" placeholder="جستجو (پورت، نام، تگ)...">
                </div>
                
                <select id="proxyStatusFilter" class="form-modern" style="min-width: 120px;">
                    <option value="">همه وضعیت‌ها</option>
                    <option value="running">فقط فعال</option>
                    <option value="stopped">فقط متوقف</option>
                </select>
                
                <div class="vr bg-secondary opacity-25 mx-1 d-none d-md-block"></div>
                
                <button class="btn-modern btn-outline-glass" data-bs-toggle="modal" data-bs-target="#bulkCreateModal">
                    <i class="fas fa-layer-group"></i> گروهی
                </button>
                <button class="btn-modern btn-primary-glow" data-bs-toggle="modal" data-bs-target="#addProxyModal">
                    <i class="fas fa-plus"></i> پروکسی جدید
                </button>
            </div>
        </div>
        
        <div class="p-0">
            <div class="modern-table-wrapper border-0 rounded-0">
                <table id="proxiesTable" class="table-modern">
                    <thead>
                        <tr>
                            <th class="ps-4">پورت</th>
                            <th>نام / مشخصات</th>
                            <th>وضعیت</th>
                            <th>اتصالات</th>
                            <th>مصرف لحظه‌ای</th>
                            <th>حجم مصرفی</th>
                            <th>دسترسی سریع</th>
                            <th class="text-center pe-4">عملیات</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for proxy in proxies %}
                        <tr>
                            <td data-label="پورت" class="ps-4">
                                <span class="font-monospace fw-bold text-info fs-5" data-proxy-port="{{ proxy.port }}">{{ proxy.port }}</span>
                            </td>
                            <td data-label="مشخصات">
                                <div class="d-flex flex-column">
                                    <span class="fw-bold text-white">{{ proxy.name or 'کاربر ناشناس' }}</span>
                                    {% if proxy.tag %}
                                        <span class="badge bg-secondary bg-opacity-20 text-secondary fw-normal mt-1 w-auto align-self-start border border-white border-opacity-10" data-proxy-tag="{{ proxy.tag }}">
                                            <i class="fas fa-tag me-1" style="font-size: 0.7em;"></i>{{ proxy.tag }}
                                        </span>
                                    {% endif %}
                                </div>
                            </td>
                            <td data-label="وضعیت">
                                {% if proxy.status == 'running' %}
                                    <span class="badge-status status-running" data-proxy-status="running">ACTIVE</span>
                                {% else %}
                                    <span class="badge-status status-stopped" data-proxy-status="stopped">STOPPED</span>
                                {% endif %}
                            </td>
                            <td data-label="اتصالات">
                                <div class="d-flex align-items-center gap-2 cursor-pointer p-1 rounded hover-bg" onclick="openProxyDetails({{ proxy.id|tojson }}, {{ proxy.port|tojson }})">
                                    <i class="fas fa-users text-muted small"></i>
                                    <span class="text-white fw-bold" id="proxy-users-{{ proxy.id }}">{{ proxy.active_connections }}</span>
                                </div>
                            </td>
                            <td data-label="مصرف لحظه‌ای">
                                <span class="font-monospace text-warning small" id="proxy-download-rate-{{ proxy.id }}">0 B/s</span>
                            </td>
                            <td data-label="حجم کل">
                                <div class="d-flex flex-column" style="min-width: 140px;">
                                    <div class="d-flex justify-content-between small mb-1 text-secondary">
                                        <span id="proxy-quota-used-{{ proxy.id }}" class="text-white font-monospace">-</span>
                                        <span class="font-monospace">/</span>
                                        <span id="proxy-quota-total-{{ proxy.id }}" class="font-monospace">-</span>
                                    </div>
                                    <div class="progress-track" style="height: 4px;">
                                        <div id="proxy-quota-bar-{{ proxy.id }}" class="progress-fill bg-info" style="width: 0%"></div>
                                    </div>
                                    {% if proxy.expiry_date %}
                                        <small class="text-muted mt-1 font-monospace text-end" style="font-size: 0.7rem;">Exp: {{ proxy.expiry_date.strftime('%Y-%m-%d') }}</small>
                                    {% endif %}
                                </div>
                            </td>
                            <td data-label="لینک">
                                <div class="d-flex gap-2">
                                    <button class="btn-modern btn-outline-glass btn-icon-sm" onclick="copyToClipboard({{ proxy.secret|tojson|forceescape }})" title="کپی سکرت">
                                        <i class="far fa-copy"></i>
                                    </button>
                                    <button class="btn-modern btn-outline-glass btn-icon-sm" onclick="showLink('{{ proxy.port }}', {{ proxy.secret|tojson|forceescape }}, {{ proxy.proxy_ip|tojson|forceescape }})" title="QR Code">
                                        <i class="fas fa-qrcode"></i>
                                    </button>
                                </div>
                            </td>
                            <td data-label="عملیات" class="pe-4">
                                <div class="d-flex gap-2 justify-content-end align-items-center">
                                    {% if proxy.status == 'running' %}
                                    <a href="{{ url_for('proxy.stop', id=proxy.id) }}" class="btn-modern btn-outline-glass btn-icon-sm text-danger border-danger border-opacity-25" title="توقف">
                                        <i class="fas fa-stop"></i>
                                    </a>
                                    {% else %}
                                    <a href="{{ url_for('proxy.start', id=proxy.id) }}" class="btn-modern btn-outline-glass btn-icon-sm text-success border-success border-opacity-25" title="شروع">
                                        <i class="fas fa-play"></i>
                                    </a>
                                    {% endif %}
                                    
                                    <a href="{{ url_for('proxy.restart', id=proxy.id) }}" class="btn-modern btn-outline-glass btn-icon-sm text-warning" title="ریستارت"><i class="fas fa-sync-alt"></i></a>
                                    
                                    <button class="btn-modern btn-outline-glass btn-icon-sm text-primary" onclick="openProxyEdit({{ proxy.id|tojson }}, {{ proxy.port|tojson }}, {{ proxy.tag|tojson|forceescape }}, {{ ((proxy.quota_bytes / (1024*1024*1024))|round(2) if proxy.quota_bytes else 0)|tojson }}, {{ proxy.secret|tojson|forceescape }}, {{ proxy.status|tojson|forceescape }}, {{ proxy.username|tojson|forceescape }}, {{ proxy.password|tojson|forceescape }}, {{ proxy.proxy_ip|tojson|forceescape }}, {{ proxy.name|tojson|forceescape }})" title="ویرایش">
                                        <i class="fas fa-pen"></i>
                                    </button>
                                    
                                    <div class="vr bg-secondary opacity-25 mx-1"></div>

                                    <a href="{{ url_for('proxy.delete', id=proxy.id) }}" onclick="return confirm('آیا از حذف این پروکسی اطمینان دارید؟')" class="btn-modern btn-outline-glass btn-icon-sm text-danger" title="حذف">
                                        <i class="fas fa-trash-alt"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="8" class="text-center py-5 text-secondary">هیچ پروکسی یافت نشد. دکمه "پروکسی جدید" را بزنید.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- بخش لاگ و هشدار -->
    <div class="row fade-in delay-300 pb-5">
        <div class="col-lg-5 mb-4 mb-lg-0">
            <div class="glass-panel h-100">
                <div class="panel-header">
                    <h5 class="panel-title text-warning"><i class="fas fa-bell"></i> آخرین هشدارها</h5>
                    <span class="badge bg-danger rounded-pill bg-opacity-20 text-danger border border-danger border-opacity-25" id="alertsCount">0</span>
                </div>
                <div class="panel-body p-0">
                    <ul class="list-group list-group-flush bg-transparent" id="alertsList">
                        <li class="list-group-item text-muted border-0 py-4 text-center bg-transparent small">همه چیز آرام است.</li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-lg-7">
            <div class="glass-panel h-100">
                <div class="panel-header">
                    <h5 class="panel-title text-secondary"><i class="fas fa-history"></i> گزارش فعالیت‌ها</h5>
                    <button class="btn btn-sm text-secondary p-0 hover-text-white" onclick="updateActivityLogs()"><i class="fas fa-sync-alt"></i></button>
                </div>
                <div class="panel-body p-0">
                    <ul class="list-group list-group-flush bg-transparent" id="activityList">
                        <li class="list-group-item text-muted border-0 py-4 text-center bg-transparent small">در حال بارگذاری...</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Proxy Modal -->
<div class="modal fade" id="addProxyModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glass-panel border-0" style="background: #1e293b;">
            <div class="modal-header border-bottom border-secondary border-opacity-10">
                <h5 class="modal-title text-white fw-bold">افزودن پروکسی جدید</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('proxy.add') }}" method="POST">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="text-secondary small mb-1">پورت (Port)</label>
                            <input type="number" name="port" class="form-modern w-100 font-monospace" required placeholder="443">
                        </div>
                         <div class="col-md-6">
                            <label class="text-secondary small mb-1">پروتکل</label>
                            <select name="proxy_type" id="proxyType" class="form-modern w-100" onchange="toggleProxyFields()">
                                <option value="standard">استاندارد</option>
                                <option value="dd">DD (Tunnel)</option>
                                <option value="tls">TLS</option>
                            </select>
                        </div>
                        <div class="col-12"><label class="text-secondary small mb-1">آی‌پی اتصال (اختیاری)</label><input type="text" name="proxy_ip" class="form-modern w-100 font-monospace" placeholder="0.0.0.0"></div>
                        <div class="col-12"><label class="text-secondary small mb-1">نام کاربر (نمایشی)</label><input type="text" name="name" class="form-modern w-100" placeholder="مثال: علی"></div>
                        <div class="col-12 d-none" id="tlsDomainField"><label class="text-secondary small mb-1">دامنه TLS</label><input type="text" name="tls_domain" class="form-modern w-100" value="google.com"></div>
                        <div class="col-12">
                            <label class="text-secondary small mb-1">سکرت (Secret)</label>
                            <div class="input-group">
                                <input type="text" name="secret" id="newSecret" class="form-modern flex-grow-1 font-monospace border-end-0 rounded-end-0" placeholder="تولید خودکار...">
                                <button class="btn btn-outline-secondary border-start-0 rounded-start-0" type="button" onclick="generateSecret()"><i class="fas fa-dice text-white"></i></button>
                            </div>
                        </div>
                        <div class="col-md-6"><label class="text-secondary small mb-1">تگ</label><input type="text" name="tag" class="form-modern w-100" placeholder="vip, test..."></div>
                        <div class="col-md-6"><label class="text-secondary small mb-1">تعداد Worker</label><input type="number" name="workers" class="form-modern w-100" value="1" min="1" max="4"></div>
                         <div class="col-md-6"><label class="text-secondary small mb-1">حجم (GB)</label><input type="number" name="quota_gb" class="form-modern w-100" placeholder="خالی = نامحدود"></div>
                         <div class="col-md-6"><label class="text-secondary small mb-1">اعتبار (روز)</label><input type="number" name="expiry_days" class="form-modern w-100" placeholder="خالی = نامحدود"></div>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn-modern btn-outline-glass" data-bs-dismiss="modal">انصراف</button>
                    <button type="submit" class="btn-modern btn-primary-glow px-4">ایجاد</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Proxy Modal -->
<div class="modal fade" id="editProxyModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content glass-panel border-0" style="background: #1e293b;">
            <div class="modal-header border-bottom border-secondary border-opacity-10">
                <h5 class="modal-title text-white fw-bold">ویرایش تنظیمات</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="editProxyForm" method="POST">
                <div class="modal-body">
                    <div class="alert alert-warning small bg-warning bg-opacity-10 text-warning border border-warning border-opacity-25 p-2 mb-4 rounded-3 d-flex align-items-center">
                        <i class="fas fa-exclamation-triangle me-2 fs-5"></i>
                        <span>تغییر پورت یا سکرت باعث قطع موقت اتصال کاربر می‌شود.</span>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-6"><label class="small text-secondary mb-1">پورت</label><input type="number" name="port" id="editProxyPort" class="form-modern w-100" required></div>
                        <div class="col-md-6"><label class="small text-secondary mb-1">آی‌پی اتصال</label><input type="text" name="proxy_ip" id="editProxyIP" class="form-modern w-100 font-monospace"></div>
                        
                        <div class="col-12"><label class="small text-secondary mb-1">سکرت</label>
                            <div class="input-group">
                                <input type="text" name="secret" id="editProxySecret" class="form-modern flex-grow-1 font-monospace border-end-0 rounded-end-0">
                                <button class="btn btn-outline-secondary border-start-0 rounded-start-0" type="button" onclick="document.getElementById('editProxySecret').value = generateRandomHex()"><i class="fas fa-sync text-white"></i></button>
                            </div>
                        </div>
                        
                        <div class="col-md-6"><label class="small text-secondary mb-1">نام نمایشی</label><input type="text" name="name" id="editProxyName" class="form-modern w-100"></div>
                        <div class="col-md-6"><label class="small text-secondary mb-1">تگ</label><input type="text" name="tag" id="editProxyTag" class="form-modern w-100"></div>
                        <div class="col-md-6"><label class="small text-secondary mb-1">وضعیت سرویس</label>
                            <select name="status" id="editProxyStatus" class="form-modern w-100">
                                <option value="running">فعال (Running)</option>
                                <option value="stopped">متوقف (Stopped)</option>
                            </select>
                        </div>
                        
                        <div class="col-12"><hr class="border-secondary border-opacity-25 my-3"></div>
                        <h6 class="text-white small mb-3 opacity-75">تنظیمات SOCKS5 (اختیاری)</h6>
                        <div class="col-md-6"><label class="small text-secondary mb-1">نام کاربری</label><input type="text" name="username" id="editProxyUser" class="form-modern w-100"></div>
                        <div class="col-md-6"><label class="small text-secondary mb-1">رمز عبور</label><input type="text" name="password" id="editProxyPass" class="form-modern w-100"></div>

                        <div class="col-12"><hr class="border-secondary border-opacity-25 my-3"></div>
                        <div class="col-md-6"><label class="small text-secondary mb-1">محدودیت حجم (GB)</label><input type="number" name="quota_gb" id="editProxyQuota" class="form-modern w-100"></div>
                        <div class="col-md-6"><label class="small text-secondary mb-1">تمدید اعتبار (روز)</label><input type="number" name="expiry_days" id="editProxyExpiry" class="form-modern w-100"></div>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn-modern btn-outline-glass" data-bs-dismiss="modal">لغو تغییرات</button>
                    <button type="submit" class="btn-modern btn-primary-glow px-4">ذخیره و اعمال</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bulk Create Modal -->
<div class="modal fade" id="bulkCreateModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glass-panel border-0" style="background: #1e293b;">
            <div class="modal-header border-bottom border-secondary border-opacity-10">
                <h5 class="modal-title text-white fw-bold">ساخت گروهی پروکسی</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('proxy.bulk_create') }}" method="POST">
                <div class="modal-body">
                    <div class="alert alert-info small bg-info bg-opacity-10 text-info border border-info border-opacity-25 p-2 mb-3 rounded">
                        <i class="fas fa-info-circle me-1"></i> پروکسی‌ها به صورت متوالی و پشت سر هم ساخته می‌شوند.
                    </div>
                    <div class="mb-3"><label class="text-secondary small mb-1">پورت شروع</label><input type="number" name="start_port" class="form-modern w-100" required placeholder="مثلا: 20000"></div>
                    <div class="mb-3"><label class="text-secondary small mb-1">تعداد مورد نیاز</label><input type="number" name="count" class="form-modern w-100" value="10"></div>
                    <div class="mb-3"><label class="text-secondary small mb-1">تگ مشترک</label><input type="text" name="tag" class="form-modern w-100" placeholder="مثلا: batch-1"></div>
                    <div class="mb-3"><label class="text-secondary small mb-1">پیشوند نام</label><input type="text" name="name_prefix" class="form-modern w-100" placeholder="User-"></div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="submit" class="btn-modern btn-primary-glow w-100">شروع عملیات ساخت</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Details Modal -->
<div class="modal fade" id="proxyDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content glass-panel border-0" style="background: #1e293b;">
            <div class="modal-header border-bottom border-secondary border-opacity-10">
                <h5 class="modal-title text-white fw-bold">جزئیات و مانیتورینگ <span id="detailsPort" class="text-info font-monospace mx-2 bg-info bg-opacity-10 px-2 rounded"></span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-4">
                    <div class="col-lg-4">
                        <div class="card bg-transparent border border-secondary border-opacity-25 h-100 rounded-3 overflow-hidden">
                            <div class="card-header border-bottom border-secondary border-opacity-10 py-2 d-flex justify-content-between align-items-center bg-dark bg-opacity-50">
                                <h6 class="mb-0 text-white small fw-bold">اتصالات زنده</h6>
                                <input id="connIpFilter" class="form-control form-control-sm bg-dark border-secondary border-opacity-25 text-white w-50" placeholder="فیلتر IP..." style="font-size: 0.8rem;">
                            </div>
                            <div class="card-body p-0 position-relative">
                                <div class="table-responsive" style="max-height: 300px;">
                                    <table class="table table-sm table-dark table-hover mb-0 bg-transparent">
                                        <thead class="text-secondary sticky-top bg-dark"><tr><th class="small fw-normal">IP Address</th><th class="small fw-normal">Location</th><th class="small fw-normal">Time</th></tr></thead>
                                        <tbody id="connectionsTable"><tr><td colspan="3" class="text-center text-secondary small py-3">در حال بارگذاری...</td></tr></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-8">
                        <div class="card bg-transparent border border-secondary border-opacity-25 mb-3 rounded-3">
                            <div class="card-header border-0 py-2 bg-dark bg-opacity-50"><h6 class="mb-0 text-white small fw-bold">ترافیک لحظه‌ای (Real-time)</h6></div>
                            <div class="card-body p-2"><div style="height: 180px;"><canvas id="connectionsChart"></canvas></div></div>
                        </div>
                         <div class="card bg-transparent border border-secondary border-opacity-25 rounded-3">
                            <div class="card-header border-0 py-2 d-flex justify-content-between align-items-center bg-dark bg-opacity-50">
                                <h6 class="mb-0 text-white small fw-bold">تاریخچه مصرف</h6>
                                <select id="usageGranularity" class="form-select form-select-sm bg-dark text-white border-secondary border-opacity-25 w-auto" style="font-size: 0.8rem;"><option value="daily">روزانه</option><option value="hourly">ساعتی</option></select>
                            </div>
                            <div class="card-body p-2"><div style="height: 180px;"><canvas id="usageChart"></canvas></div></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn-modern btn-outline-glass" data-bs-dismiss="modal">بستن</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // --- Chart Global Config ---
    Chart.defaults.font.family = 'Vazirmatn'; 
    Chart.defaults.color = '#94a3b8'; 
    Chart.defaults.borderColor = 'rgba(255,255,255,0.05)';
    Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(15, 23, 42, 0.9)';
    Chart.defaults.plugins.tooltip.titleColor = '#fff';
    Chart.defaults.plugins.tooltip.bodyColor = '#cbd5e1';
    Chart.defaults.plugins.tooltip.borderColor = 'rgba(255,255,255,0.1)';
    Chart.defaults.plugins.tooltip.borderWidth = 1;
    Chart.defaults.plugins.tooltip.padding = 10;

    // --- Helper Functions ---
    const formatBytes = (bytes, decimals = 2) => {
        if (!+bytes) return '0 Bytes';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
    };
    const formatMB = (mb) => formatBytes(mb * 1024 * 1024);

    const copyToClipboard = (text) => { 
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(text).then(() => {
                Swal.fire({toast:true, position:'bottom', icon:'success', title:'کپی شد', showConfirmButton:false, timer:1500, background:'#1e293b', color:'#fff'});
            });
        } else {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                Swal.fire({toast:true, position:'bottom', icon:'success', title:'کپی شد', showConfirmButton:false, timer:1500, background:'#1e293b', color:'#fff'});
            } catch (err) {
                Swal.fire({toast:true, position:'bottom', icon:'error', title:'خطا', showConfirmButton:false, timer:1500, background:'#1e293b', color:'#fff'});
            }
            document.body.removeChild(textArea);
        }
    };

    const generateSecret = () => {
        const type = document.getElementById('proxyType').value;
        if(type==='tls') { document.getElementById('newSecret').value=''; return; }
        let sec = [...Array(32)].map(()=>Math.floor(Math.random()*16).toString(16)).join('');
        document.getElementById('newSecret').value = type==='dd' ? 'dd'+sec : sec;
    };
    const generateRandomHex = () => [...Array(32)].map(()=>Math.floor(Math.random()*16).toString(16)).join('');
    const toggleProxyFields = () => { document.getElementById('tlsDomainField').classList.toggle('d-none', document.getElementById('proxyType').value !== 'tls'); };
    
    function showLink(port, secret, proxyIp) {
        const serverIp = proxyIp || '{{ server_ip }}' || window.location.hostname;
        const link = `tg://proxy?server=${serverIp}&port=${port}&secret=${secret}`;
        Swal.fire({
            html: `
                <div class="mb-3 text-start">
                    <label class="small text-secondary mb-1">لینک اتصال تلگرام</label>
                    <div class="input-group">
                        <input class="form-control bg-dark text-white text-center font-monospace border-secondary border-opacity-25" value="${link}" readonly id="swalLinkInput">
                        <button class="btn btn-outline-secondary" onclick="copyToClipboard(document.getElementById('swalLinkInput').value)"><i class="far fa-copy"></i></button>
                    </div>
                </div>
                <a href="${link}" class="btn btn-primary-glow w-100 py-2"><i class="fab fa-telegram-plane me-2"></i>اتصال مستقیم</a>
            `,
            background: '#1e293b', 
            showConfirmButton: false, 
            showCloseButton: true,
            customClass: { popup: 'glass-panel border-0' }
        });
    }
    
    function formatUptime(seconds) {
        const d = Math.floor(seconds / (3600*24));
        const h = Math.floor(seconds % (3600*24) / 3600);
        const m = Math.floor(seconds % 3600 / 60);
        return d > 0 ? `${d}d ${h}h` : `${h}h ${m}m`;
    }

    // --- Charts Initialization ---
    const ctxSys = document.getElementById('systemChart').getContext('2d');
    const gradSys = ctxSys.createLinearGradient(0, 0, 0, 300);
    gradSys.addColorStop(0, 'rgba(99, 102, 241, 0.4)');
    gradSys.addColorStop(1, 'rgba(99, 102, 241, 0.0)');

    const sysChart = new Chart(ctxSys, {
        type: 'line', 
        data: { 
            labels: Array(20).fill(''), 
            datasets: [
                { label:'CPU Load', data:Array(20).fill(0), borderColor:'#6366f1', backgroundColor:gradSys, fill:true, tension:0.4, borderWidth: 2, pointRadius:0, pointHoverRadius: 4 }, 
                { label:'RAM Usage', data:Array(20).fill(0), borderColor:'#10b981', borderDash:[5,5], tension:0.4, borderWidth: 2, pointRadius:0, pointHoverRadius: 4 }
            ] 
        },
        options: { 
            responsive:true, 
            maintainAspectRatio:false, 
            interaction: { mode: 'index', intersect: false },
            plugins:{ legend:{ display:true, labels:{ usePointStyle:true, boxWidth:8 } } }, 
            scales:{ x:{ display:false }, y:{ beginAtZero:true, max:100, grid:{ color:'rgba(255,255,255,0.03)' } } } 
        }
    });

    const trafChart = new Chart(document.getElementById('trafficChart'), {
        type: 'bar', 
        data: { labels:[], datasets:[{ label:'دانلود (MB)', data:[], backgroundColor:'#3b82f6', borderRadius:4, barThickness: 12 }] },
        options: { 
            responsive:true, 
            maintainAspectRatio:false, 
            plugins:{ legend:{ display:false } }, 
            scales:{ x:{ grid:{ display:false } }, y:{ grid:{ color:'rgba(255,255,255,0.03)' } } } 
        }
    });
    
    let currentProxyId, connChart, usageChart, lastAlertId = 0, lastNetSent=null, lastNetRecv=null, lastTime=Date.now();
    
    // --- Logic ---
    const updateStats = () => fetch('/api/stats').then(r=>r.json()).then(d => {
        document.getElementById('cpu-usage').innerText = d.cpu; 
        document.getElementById('ram-usage').innerText = d.mem_percent;
        document.getElementById('ram-used').innerText = d.mem_used; 
        document.getElementById('ram-total').innerText = d.mem_total;
        
        if(d.uptime) document.getElementById('uptime-display').innerText = formatUptime(d.uptime);
        if(d.load_avg) document.getElementById('load-avg-display').innerText = d.load_avg[0];
        
        // Net Speed
        const now = Date.now(); const tDiff = (now - lastTime)/1000;
        if(lastNetRecv!==null && tDiff>0) {
            const speedBytes = ((d.net_recv - lastNetRecv) * 1024 * 1024) / tDiff;
            document.getElementById('net-down-speed').innerText = (speedBytes / (1024*1024)).toFixed(2);
        }
        lastNetRecv = d.net_recv; lastTime = now;
        document.getElementById('net-total-down').innerText = formatMB(d.net_recv);

        // Update Sys Chart
        document.getElementById('cpu-bar').style.width = d.cpu+'%'; 
        document.getElementById('ram-bar').style.width = d.mem_percent+'%';
        
        sysChart.data.datasets[0].data.push(d.cpu); sysChart.data.datasets[0].data.shift();
        sysChart.data.datasets[1].data.push(d.mem_percent); sysChart.data.datasets[1].data.shift();
        sysChart.update('none'); // 'none' for performance
    });
    
    const updateProxies = () => fetch('/api/proxies').then(r=>r.json()).then(d => {
        d.forEach(p => {
            const els = { 
                u:document.getElementById(`proxy-users-${p.id}`), 
                r:document.getElementById(`proxy-download-rate-${p.id}`), 
                qU:document.getElementById(`proxy-quota-used-${p.id}`), 
                qT:document.getElementById(`proxy-quota-total-${p.id}`), 
                qB:document.getElementById(`proxy-quota-bar-${p.id}`) 
            };
            if(els.u) els.u.innerText = p.active_connections;
            if(els.r) els.r.innerText = (p.download_rate_mbps||0) + ' MB/s';
            if(p.quota_mb && els.qU) {
                els.qU.innerText = (p.quota_used_mb/1024).toFixed(2) + ' GB'; 
                els.qT.innerText = (p.quota_mb/1024).toFixed(2);
                const percent = Math.min(100, (p.quota_used_mb/p.quota_mb)*100);
                els.qB.style.width = percent + '%';
                els.qB.className = `progress-fill ${percent > 90 ? 'bg-danger' : (percent > 70 ? 'bg-warning' : 'bg-info')}`;
            }
        });
        applyProxyFilters();
    });

    const updateTrafficHistory = () => fetch('/api/history').then(r=>r.json()).then(d => {
        trafChart.data.labels = d.labels; trafChart.data.datasets[0].data = d.download; trafChart.update();
    });

    const applyProxyFilters = () => {
        const search = (document.getElementById('proxySearch')?.value||'').toLowerCase();
        const status = (document.getElementById('proxyStatusFilter')?.value||'').toLowerCase();
        document.querySelectorAll('#proxiesTable tbody tr').forEach(tr => {
            const port = (tr.querySelector('[data-proxy-port]')?.getAttribute('data-proxy-port')||'').toLowerCase();
            const tag = (tr.querySelector('[data-proxy-tag]')?.getAttribute('data-proxy-tag')||'').toLowerCase();
            const st = (tr.querySelector('[data-proxy-status]')?.getAttribute('data-proxy-status')||'').toLowerCase();
            tr.style.display = ((port.includes(search)||tag.includes(search)) && (!status || st===status)) ? '' : 'none';
        });
    };

    const updateAlerts = () => fetch(`/api/alerts?since_id=${lastAlertId}`).then(r=>r.json()).then(items => {
        if(!items || !items.length) return;
        const list = document.getElementById('alertsList');
        items.forEach(a => {
            lastAlertId = Math.max(lastAlertId, a.id);
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center bg-transparent border-bottom border-secondary border-opacity-10 text-white small py-2 fade-in';
            li.innerHTML = `<span><i class="fas fa-exclamation-circle text-warning me-2"></i>${a.message}</span><span class="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25 rounded-pill ms-2">${a.severity}</span>`;
            if(list.firstElementChild?.classList.contains('text-center')) list.innerHTML = '';
            list.prepend(li);
        });
        document.getElementById('alertsCount').innerText = list.children.length;
    });

    const updateActivityLogs = () => fetch('/api/activity?limit=10').then(r=>r.json()).then(items => {
        const list = document.getElementById('activityList');
        if(!list) return;
        if(!items.length) { list.innerHTML = `<li class="list-group-item text-secondary border-0 text-center py-3 bg-transparent small">هنوز فعالیتی ثبت نشده است.</li>`; return; }
        list.innerHTML = items.map(it => `
            <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent border-bottom border-secondary border-opacity-10 py-3">
                <div class="d-flex align-items-center overflow-hidden">
                    <div class="rounded-3 bg-secondary bg-opacity-10 p-2 me-3 text-secondary d-flex align-items-center justify-content-center" style="width: 36px; height: 36px;"><i class="fas fa-terminal small"></i></div>
                    <div class="text-truncate">
                        <div class="text-white small fw-bold text-truncate">${it.action}</div>
                        <div class="text-secondary small text-truncate" style="font-size: 0.75rem;">${it.details || ''}</div>
                    </div>
                </div>
                <span class="text-muted small font-monospace ms-2" style="font-size: 0.7rem;">${new Date(it.timestamp).toLocaleTimeString('fa-IR', {hour:'2-digit', minute:'2-digit'})}</span>
            </li>
        `).join('');
    });

    // Modal Helpers
    const openProxyEdit = (id, port, tag, quota, secret, status, user, pass, ip, name) => {
        const form = document.getElementById('editProxyForm'); form.action = `/proxy/update/${id}`;
        document.getElementById('editProxyPort').value = port;
        document.getElementById('editProxyName').value = name||'';
        document.getElementById('editProxySecret').value = secret;
        document.getElementById('editProxyQuota').value = quota||'';
        document.getElementById('editProxyStatus').value = status;
        document.getElementById('editProxyTag').value = tag||'';
        document.getElementById('editProxyUser').value = user||'';
        document.getElementById('editProxyPass').value = pass||'';
        document.getElementById('editProxyIP').value = ip||'';
        new bootstrap.Modal(document.getElementById('editProxyModal')).show();
    };

    const openProxyDetails = (id, port) => {
        currentProxyId = id; document.getElementById('detailsPort').innerText = port;
        new bootstrap.Modal(document.getElementById('proxyDetailsModal')).show();
        updateConnections(id);
        updateUsageHistory(id);
        
        if(!connChart) connChart = new Chart(document.getElementById('connectionsChart'), { 
            type:'line', 
            data:{labels:[], datasets:[{data:[], borderColor:'#ef4444', backgroundColor:'rgba(239,68,68,0.1)', fill:true, tension:0.4, pointRadius:0, borderWidth:2}]}, 
            options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{grid:{color:'rgba(255,255,255,0.03)'}}} } 
        });
        
        if(!usageChart) usageChart = new Chart(document.getElementById('usageChart'), { 
            type:'bar', 
            data:{labels:[], datasets:[{data:[], backgroundColor:'#10b981', borderRadius:2}]}, 
            options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{grid:{color:'rgba(255,255,255,0.03)'}}} } 
        });
    };

    const updateConnections = (id) => {
        const f = document.getElementById('connIpFilter')?.value || '';
        fetch(`/api/proxy/${id}/connections${f ? '?ip='+encodeURIComponent(f) : ''}`).then(r=>r.json()).then(d => {
            const tbody = document.getElementById('connectionsTable');
            tbody.innerHTML = d.items?.length ? d.items.map(i=>`<tr><td class="font-monospace text-info small">${i.ip}</td><td class="text-white small">${i.country||'-'}</td><td class="font-monospace small text-muted">${i.connected_for||'-'}</td></tr>`).join('') : '<tr><td colspan="3" class="text-center text-muted small py-3">بدون اتصال فعال</td></tr>';
        });
        fetch(`/api/proxy/${id}/connections_history?minutes=60`).then(r=>r.json()).then(d => { if(connChart) { connChart.data.labels = d.labels; connChart.data.datasets[0].data = d.values; connChart.update(); }});
    };

    const updateUsageHistory = (id) => {
        const g = document.getElementById('usageGranularity')?.value || 'daily';
        fetch(`/api/proxy/${id}/usage_history?granularity=${g}&days=30`).then(r=>r.json()).then(d => { if(usageChart) { usageChart.data.labels = d.labels; usageChart.data.datasets[0].data = d.download_mb; usageChart.update(); }});
    };

    // Listeners
    document.getElementById('proxySearch')?.addEventListener('input', applyProxyFilters);
    document.getElementById('proxyStatusFilter')?.addEventListener('change', applyProxyFilters);
    document.getElementById('connIpFilter')?.addEventListener('input', () => { if(currentProxyId) updateConnections(currentProxyId); });
    document.getElementById('usageGranularity')?.addEventListener('change', () => { if(currentProxyId) updateUsageHistory(currentProxyId); });

    // Timers
    setInterval(updateStats, 2000); 
    setInterval(updateProxies, 5000);
    setInterval(updateAlerts, 10000);
    setInterval(updateTrafficHistory, 60000);
    setInterval(() => { if(currentProxyId && document.getElementById('proxyDetailsModal').classList.contains('show')) updateConnections(currentProxyId); }, 5000);

    // Init
    updateStats(); updateProxies(); updateTrafficHistory(); updateAlerts(); updateActivityLogs();
</script>
{% endblock %}