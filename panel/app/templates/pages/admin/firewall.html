{% extends "layouts/base.html" %}

{% block title %}فایروال | HoseinProxy{% endblock %}

{% block content %}
<style>
    /* استایل‌های اختصاصی صفحه فایروال (هماهنگ با داشبورد) */
    :root {
        --card-bg: rgba(30, 41, 59, 0.4);
        --card-border: rgba(255, 255, 255, 0.08);
        --text-secondary: #94a3b8;
        --glass-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
    }

    #starfield {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        z-index: -1;
        background: radial-gradient(circle at top center, #1e293b 0%, #020617 80%);
        pointer-events: none;
    }

    .glass-card {
        background: var(--card-bg);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid var(--card-border);
        border-radius: 16px;
        box-shadow: var(--glass-shadow);
        transition: transform 0.3s ease, border-color 0.3s;
        overflow: hidden;
    }

    .glass-card:hover {
        border-color: rgba(139, 92, 246, 0.3);
        transform: translateY(-2px);
    }

    .card-header-clean {
        background: rgba(255, 255, 255, 0.03);
        border-bottom: 1px solid var(--card-border);
        padding: 1.25rem 1.5rem;
    }

    .form-control {
        background-color: rgba(15, 23, 42, 0.6) !important;
        border: 1px solid var(--card-border) !important;
        color: #fff !important;
        border-radius: 10px;
        padding: 0.7rem 1rem;
    }

    .form-control:focus {
        background-color: rgba(15, 23, 42, 0.9) !important;
        border-color: #ef4444 !important; /* قرمز برای فایروال */
        box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.1) !important;
    }

    .btn-glow-danger {
        background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%);
        border: none; color: white;
        box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        transition: all 0.3s;
    }
    .btn-glow-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(239, 68, 68, 0.6);
    }

    /* جدول */
    .table-firewall {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }
    .table-firewall th {
        color: var(--text-secondary);
        font-weight: 600;
        border-bottom: 1px solid var(--card-border);
        padding: 1rem;
    }
    .table-firewall td {
        padding: 1rem;
        border-bottom: 1px solid rgba(255,255,255,0.03);
        color: #f8fafc;
        vertical-align: middle;
    }
    .table-firewall tr:last-child td { border-bottom: none; }
    .table-firewall tbody tr { transition: background 0.2s; }
    .table-firewall tbody tr:hover { background: rgba(255,255,255,0.03); }

    .fade-in-up { animation: fadeInUp 0.6s ease-out forwards; opacity: 0; transform: translateY(20px); }
    @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
    .delay-1 { animation-delay: 0.1s; }
    .delay-2 { animation-delay: 0.2s; }
</style>

<!-- بوم پس‌زمینه -->
<canvas id="starfield"></canvas>

<div class="container-fluid py-4 px-lg-5">
    
    <!-- هدر صفحه -->
    <div class="d-flex justify-content-between align-items-center mb-5 fade-in-up">
        <div>
            <h2 class="fw-bold text-white mb-1">مدیریت فایروال</h2>
            <p class="text-secondary mb-0">کنترل دسترسی‌ها و مسدودسازی آی‌پی‌های مخرب</p>
        </div>
        <div class="glass-card px-3 py-2 d-flex align-items-center gap-2">
            <span class="badge bg-danger bg-opacity-20 text-danger rounded-pill px-3">
                <i class="fas fa-shield-alt me-1"></i> فعال
            </span>
            <span class="text-secondary small border-start border-secondary border-opacity-25 ps-2">
                {{ blocked_ips|length }} مسدودی
            </span>
        </div>
    </div>

    <div class="row g-4">
        
        <!-- فرم مسدودسازی -->
        <div class="col-lg-4 fade-in-up delay-1">
            <div class="glass-card h-100 position-sticky" style="top: 100px;">
                <div class="card-header-clean">
                    <h5 class="mb-0 text-white"><i class="fas fa-ban me-2 text-danger"></i>مسدود کردن IP</h5>
                </div>
                <div class="p-4">
                    <form action="{{ url_for('firewall.add') }}" method="POST">
                        <div class="mb-3">
                            <label class="form-label text-secondary small">آدرس IP</label>
                            <input type="text" name="ip" class="form-control font-monospace" placeholder="e.g. 192.168.1.1" required>
                        </div>
                        <div class="mb-4">
                            <label class="form-label text-secondary small">علت مسدودی (اختیاری)</label>
                            <textarea name="reason" class="form-control" rows="2" placeholder="توضیحات (مثلاً: اسپم، حمله...)"></textarea>
                        </div>
                        <button type="submit" class="btn btn-glow-danger w-100 py-2 rounded-3">
                            <i class="fas fa-lock me-2"></i> افزودن به لیست سیاه
                        </button>
                    </form>
                    
                    <div class="mt-4 p-3 rounded-3 bg-danger bg-opacity-10 border border-danger border-opacity-25">
                        <div class="d-flex">
                            <i class="fas fa-info-circle text-danger mt-1 me-2"></i>
                            <p class="small text-white opacity-75 mb-0" style="line-height: 1.6;">
                                آی‌پی‌های وارد شده در سطح هسته لینوکس (iptables) مسدود می‌شوند و امکان برقراری هیچ‌گونه اتصالی به سرور را نخواهند داشت.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- لیست مسدودی‌ها -->
        <div class="col-lg-8 fade-in-up delay-2">
            <div class="glass-card h-100">
                <div class="card-header-clean d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-white"><i class="fas fa-list-ul me-2 text-secondary"></i>لیست سیاه (Blocklist)</h5>
                    <div class="input-group input-group-sm w-auto">
                        <span class="input-group-text bg-transparent border-secondary border-opacity-25 text-secondary border-end-0"><i class="fas fa-search"></i></span>
                        <input type="text" id="searchIp" class="form-control bg-transparent border-secondary border-opacity-25 text-white border-start-0" placeholder="جستجو..." style="background: transparent !important;">
                    </div>
                </div>
                <div class="p-0 table-responsive">
                    <table class="table-firewall" id="firewallTable">
                        <thead>
                            <tr>
                                <th class="ps-4">آدرس IP</th>
                                <th>علت مسدودی</th>
                                <th>زمان ثبت</th>
                                <th class="text-end pe-4">عملیات</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in blocked_ips %}
                            <tr>
                                <td class="ps-4">
                                    <div class="d-flex align-items-center">
                                        <div class="bg-danger bg-opacity-10 text-danger rounded p-2 me-3 d-flex align-items-center justify-content-center" style="width: 36px; height: 36px;">
                                            <i class="fas fa-spider"></i>
                                        </div>
                                        <span class="font-monospace fw-bold text-danger-emphasis fs-5">{{ item.ip_address }}</span>
                                    </div>
                                </td>
                                <td>
                                    {% if item.reason %}
                                        <span class="text-white small">{{ item.reason }}</span>
                                    {% else %}
                                        <span class="text-secondary small fst-italic">- بدون توضیح -</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="d-flex align-items-center text-secondary small">
                                        <i class="far fa-clock me-1 opacity-50"></i>
                                        <span dir="ltr">{{ item.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                                    </div>
                                </td>
                                <td class="text-end pe-4">
                                    <a href="{{ url_for('firewall.delete', id=item.id) }}" class="btn btn-outline-success btn-sm rounded-pill px-3" title="آزاد کردن">
                                        <i class="fas fa-unlock me-1"></i> رفع مسدودی
                                    </a>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="4" class="text-center py-5">
                                    <div class="d-flex flex-column align-items-center text-secondary opacity-50">
                                        <i class="fas fa-shield-virus fa-3x mb-3"></i>
                                        <p>هیچ آی‌پی مسدود شده‌ای یافت نشد.</p>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // --- Starfield Animation (کپی شده برای هماهنگی با داشبورد) ---
    const canvas = document.getElementById('starfield');
    const ctx = canvas.getContext('2d');
    let width, height, stars = [];
    const resizeCanvas = () => { width = window.innerWidth; height = window.innerHeight; canvas.width = width; canvas.height = height; };
    class Star {
        constructor() { this.reset(); }
        reset() { this.x = Math.random()*width; this.y = Math.random()*height; this.size = Math.random()*1.5+0.5; this.speed = Math.random()*0.1+0.02; this.opacity = Math.random()*0.8; }
        update() { this.y -= this.speed; if(this.y<0) this.reset(); }
        draw() { ctx.fillStyle = `rgba(255,255,255,${this.opacity})`; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fill(); }
    }
    const initStars = () => { stars = Array.from({length:100}, () => new Star()); };
    const animateStars = () => { ctx.clearRect(0,0,width,height); stars.forEach(s => { s.update(); s.draw(); }); requestAnimationFrame(animateStars); };
    window.addEventListener('resize', () => { resizeCanvas(); initStars(); });
    resizeCanvas(); initStars(); animateStars();

    // --- Search Functionality ---
    document.getElementById('searchIp').addEventListener('input', function(e) {
        const term = e.target.value.toLowerCase();
        document.querySelectorAll('#firewallTable tbody tr').forEach(row => {
            const text = row.innerText.toLowerCase();
            row.style.display = text.includes(term) ? '' : 'none';
        });
    });
</script>
{% endblock %}