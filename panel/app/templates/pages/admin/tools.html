{% extends "layouts/base.html" %}

{% block title %}ابزارهای شبکه - HoseinProxy{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">ابزارهای شبکه (Network Tools)</h1>
</div>

<div class="row">
    <!-- Speedtest -->
    <div class="col-md-6 mb-4">
        <div class="card card-custom h-100">
            <div class="card-header bg-gradient-primary text-white">
                <h5 class="mb-0"><i class="fas fa-tachometer-alt me-2"></i> تست سرعت سرور (Speedtest)</h5>
            </div>
            <div class="card-body text-center">
                <div class="row mt-4">
                    <div class="col-4">
                        <h3 class="text-success" id="dl-speed">--</h3>
                        <small class="text-muted">دانلود (Mbps)</small>
                    </div>
                    <div class="col-4">
                        <h3 class="text-primary" id="ul-speed">--</h3>
                        <small class="text-muted">آپلود (Mbps)</small>
                    </div>
                    <div class="col-4">
                        <h3 class="text-warning" id="ping-speed">--</h3>
                        <small class="text-muted">پینگ (ms)</small>
                    </div>
                </div>
                
                <div class="mt-5">
                    <button class="btn btn-lg btn-outline-primary rounded-pill px-5" id="startSpeedtestBtn" onclick="startSpeedtest()">
                        <i class="fas fa-play me-2"></i> شروع تست
                    </button>
                </div>
                <div id="speedtestLoader" class="mt-3 d-none">
                    <div class="spinner-border text-primary" role="status"></div>
                    <div class="text-muted small mt-2">در حال اندازه‌گیری... (ممکن است تا ۳۰ ثانیه طول بکشد)</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ping/Traceroute -->
    <div class="col-md-6 mb-4">
        <div class="card card-custom h-100">
            <div class="card-header bg-gradient-info text-white">
                <h5 class="mb-0"><i class="fas fa-terminal me-2"></i> ابزار Ping</h5>
            </div>
            <div class="card-body">
                <div class="input-group mb-3">
                    <input type="text" class="form-control font-monospace" id="pingHost" placeholder="google.com or 8.8.8.8" value="8.8.8.8">
                    <button class="btn btn-info text-white" type="button" onclick="startPing()">
                        <i class="fas fa-search me-1"></i> Ping
                    </button>
                </div>
                
                <pre class="bg-dark text-white p-3 rounded" id="pingOutput" style="height: 200px; overflow-y: auto; font-size: 0.85rem;">خروجی دستور اینجا نمایش داده می‌شود...</pre>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    function startSpeedtest() {
        const btn = document.getElementById('startSpeedtestBtn');
        const loader = document.getElementById('speedtestLoader');
        
        btn.disabled = true;
        loader.classList.remove('d-none');
        
        // Reset values
        document.getElementById('dl-speed').innerText = '--';
        document.getElementById('ul-speed').innerText = '--';
        document.getElementById('ping-speed').innerText = '--';
        
        fetch('/api/tools/speedtest', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                btn.disabled = false;
                loader.classList.add('d-none');
                
                if (data.error) {
                    Swal.fire('خطا', data.error, 'error');
                } else {
                    document.getElementById('dl-speed').innerText = data.download;
                    document.getElementById('ul-speed').innerText = data.upload;
                    document.getElementById('ping-speed').innerText = data.ping;
                }
            })
            .catch(err => {
                btn.disabled = false;
                loader.classList.add('d-none');
                Swal.fire('خطا', 'ارتباط با سرور برقرار نشد.', 'error');
            });
    }

    function startPing() {
        const host = document.getElementById('pingHost').value;
        const output = document.getElementById('pingOutput');
        
        output.innerText = `Pinging ${host}...\n`;
        
        fetch('/api/tools/ping', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ host: host })
        })
        .then(r => r.json())
        .then(data => {
            output.innerText += data.output;
        });
    }
</script>
{% endblock %}
